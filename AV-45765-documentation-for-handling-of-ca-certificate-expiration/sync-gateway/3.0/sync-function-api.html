<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Sync Function API Reference | Couchbase Capella Staging Docs</title>
<link rel="canonical" href="https://docs.stage.nonprod-project-avengers.com/sync-gateway/3.0/sync-function-api.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Use Sync Functionss to implement effective data routing and access control in the cloud-to-edge synchronization of enterprise data.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="sync-gateway">
<meta name="dcterms.identifier" content="3.0">
<meta name="page-url" content="/sync-gateway/3.0/sync-function-api.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.stage.nonprod-project-avengers.com/cloud/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.stage.nonprod-project-avengers.com/cloud/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="2">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/hakimcassimally/couchbase/docs-sync-gateway/modules/ROOT/pages/sync-function-api.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="index.html">Sync Gateway</a></li>
<li class="crumb">Access Control</li>
<li class="crumb"><a href="sync-function.html">Sync Function</a></li>
<li class="crumb"><a href="sync-function-api.html">API Reference</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Sync Function API Reference</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Use Sync Functionss to implement effective data routing and access control in the cloud-to-edge synchronization of enterprise data.<br>
The Sync Function is crucial to the security of data sync and replication. It is in charge of data validation, access control and routing. This topic provides a reference resource on Sync and its helper functions.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><em>Related  Topics</em>:  <a href="access-control-concepts.html" class="xref page">Concepts</a>  |
<a href="access-control-how.html" class="xref page">How-to</a>  |
<a href="sync-function-overview.html" class="xref page">Sync Function</a>  |
<a href="access-control-how-use-xattrs-for-access-grants.html" class="xref page">Use XATTRs for Access Grants</a></p>
</div>
<div class="paragraph">
<p><em>Other Topics</em>: <a href="sync-function-overview.html" class="xref page">Sync Function Overview</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-access"><a class="anchor" href="#lbl-access"></a>access()</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>access(username, channelname)</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose"><a class="anchor" href="#purpose"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>access()</code> function to grant a user access to a channel.</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>username</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be a string identifying a user, or an array of strings identifying multiple users; the function is applied to each user in the array.</p>
<p class="tableblock">If the value resolves to null the function result is a no-op.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>channels</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Must be a string identifying a channel name, or an array of strings to specify multiple channel names (for example: <code>(['channel1', 'channel2'])</code>; the function is applied to each element in the array.</p>
</div>
<div class="paragraph">
<p>If the value resolves to null the function result is a no-op.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As a convenience, the resolved value of either argument may be <code>null</code> or <code>undefined</code>, in which case nothing happens.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="context"><a class="anchor" href="#context"></a>Context</h3>
<div class="paragraph">
<p>You can invoke this function multiple times from within your Sync Function.
But note that, invoking it multiple times to grant the same user access to the same channel, will result in negative performance implications.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Prefix the <code>username</code> argument value with <code>role:</code> to apply this function to a role rather than a user.
This grants access to the specified channel(s) for all users assigned that role.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The effects of all access calls by all active documents are effectively combined in a union, so if <em>any</em> document grants a user access to a channel, that user has access to the channel.</p>
</div>
<div class="paragraph">
<p>You can use the <em>all channels</em> wildcard ('<strong>*</strong>') to grant the user access to all documents in all channels.</p>
</div>
</div>
<div class="sect2">
<h3 id="use"><a class="anchor" href="#use"></a>Use</h3>
<div class="exampleblock">
<div class="title">Example 1. access(username, channel)</div>
<div class="content">
<div class="paragraph">
<p>This example shows some valid ways to call <code>access()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">access ("jchris", "mtv"); <i class="conum" data-value="1"></i><b>(1)</b>
access ("jchris", ["mtv", "mtv2", "vh1"]); <i class="conum" data-value="2"></i><b>(2)</b>
access (["snej", "jchris", "role:admin"], "vh1"); <i class="conum" data-value="3"></i><b>(3)</b>
access (["snej", "jchris"], ["mtv", "mtv2", "vh1"]); <i class="conum" data-value="4"></i><b>(4)</b>
access (null, "hbo");  <i class="conum" data-value="5"></i><b>(5)</b>
access ("snej", null);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Allow access of single channel to single user</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Allow access of multiple channels to single user</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Allow access of single channel to multiple users</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Allow access of multiple channels to multiple users</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The null arguments mean these are treated as no-ops</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-channel"><a class="anchor" href="#lbl-channel"></a>channel()</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="function-call"><a class="anchor" href="#function-call"></a>Function Call</h3>
<div class="paragraph">
<p>channel(channelname)</p>
</div>
</div>
<div class="sect2">
<h3 id="purpose-2"><a class="anchor" href="#purpose-2"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>channel()</code> function to route the document to the named channel(s).</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-2"><a class="anchor" href="#arguments-2"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>channels</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Must be a string identifying a channel name, or an array of strings to specify multiple channel names (for example: <code>(['channel1', 'channel2'])</code>; the function is applied to each element in the array.</p>
</div>
<div class="paragraph">
<p>If the value resolves to null the function result is a no-op.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="context-2"><a class="anchor" href="#context-2"></a>Context</h3>
<div class="paragraph">
<p>The channel function can be called zero or more times from the sync function, for any document.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Channels don&#8217;t have to be predefined.<br>
A channel implicitly comes into existence when a document is routed to it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Routing changes have no effect until the document is actually saved in the database, so if the sync function first calls <code>channel()</code> or <code>access()</code>, but then rejects the update, the channel and access changes will not occur.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As a convenience, it is legal to call <code>channel</code> with a <code>null</code> or <code>undefined</code> argument; it simply does nothing.<br>
This allows you to do something like <code>channel(doc.channels)</code> without having to first check whether <code>doc.channels</code> exists.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="use-2"><a class="anchor" href="#use-2"></a>Use</h3>
<div class="exampleblock">
<div class="title">Example 2. channel(channelname)</div>
<div class="content">
<div class="paragraph">
<p>This example routes all "published" documents to the "public" channel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc, meta) {
   if (doc.published) {
      channel("public");
   }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-expiry"><a class="anchor" href="#lbl-expiry"></a>expiry()</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>expiry(value)</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose-3"><a class="anchor" href="#purpose-3"></a>Purpose</h3>
<div class="paragraph">
<p>Use <code>expiry(value)</code> to set the expiry value (TTL) on the document.</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-3"><a class="anchor" href="#arguments-3"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <code>value</code> can be specified in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As an <strong>ISO-8601 format:</strong> date string&#8201;&#8212;&#8201;or example the 6th of July 2016 at 17:00 in the BST timezone would be <code>2016-07-06T17:00:00+01:00</code>;</p>
</li>
<li>
<p>As a numeric Couchbase Server expiry value <sup>1</sup></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><sup>1</sup> Couchbase Server expiries are specified as Unix time, and if the desired TTL is below 30 days then it can also represent an interval in seconds from the current time (for example, a value of 5 will remove the document 5 seconds after it is written to Couchbase Server).</p>
</div>
</div>
<div class="sect2">
<h3 id="context-3"><a class="anchor" href="#context-3"></a>Context</h3>
<div class="paragraph">
<p>Under the hood, the expiration time is set and managed on the Couchbase Server document (TTL is not supported for databases in walrus mode).</p>
</div>
<div class="sect3">
<h4 id="impact"><a class="anchor" href="#impact"></a>Impact</h4>
<div class="paragraph">
<p>The impact on the resulting document when the expiry value is reached depends on the setting of shared-bucket-access:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Enabled</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The <strong>active</strong> revision of the document is tombstoned.</p>
</div>
<div class="paragraph">
<p>If there is another non-tombstoned revision for this document (i.e a conflict) it will become the active revision.</p>
</div>
<div class="paragraph">
<p>The tombstoned revision will be purged when the server&#8217;s metadata purge interval is reached.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Disabled</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The document will be purged from the database.</p>
</div>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As with the existing explicit purge mechanism, this applies only to the local database; it has nothing to do with replication.</p>
</div>
<div class="paragraph">
<p>This expiration time is not propagated when the document is replicated.</p>
</div>
<div class="paragraph">
<p>The purge of the document does not cause it to be deleted on any other database.</p>
</div>
</div>
<div class="sect3">
<h4 id="inspect-a-document-expiry-value"><a class="anchor" href="#inspect-a-document-expiry-value"></a>Inspect a Document Expiry Value</h4>
<div class="paragraph">
<p>You can retrieve a document&#8217;s expiration time, as it is returned in the response of GET <a href="rest-api.html##/document/get<em>db</em><em>doc</em>" class="xref page">+/\{db/{doc}</a> use <code>show_exp=true</code> as the querystring.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X GET "http://localhost:4985/ourdb/ourdoc?show_exp=true" -H "accept: application/json"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-3"><a class="anchor" href="#use-3"></a>Use</h3>
<div class="exampleblock">
<div class="title">Example 3. expiry(value)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">expiry("2022-06-23T05:00:00+01:00") <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sets the expiry date to 5am on the 23rd June 2022.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-require-access"><a class="anchor" href="#lbl-require-access"></a>requireAccess()</h2>
<div class="sectionbody">
<div id="lbl-require-access" class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>requireAccess(channels)</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose-4"><a class="anchor" href="#purpose-4"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>requireAccess()</code> function to reject document updates that are not made by the a user with access to at least one of the given channels, as shown in <a href="#ex-requireaccess">Example 4</a></p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-4"><a class="anchor" href="#arguments-4"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>channels</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Must be a string identifying a channel name, or an array of strings to specify multiple channel names (for example: <code>(['channel1', 'channel2'])</code>; the function is applied to each element in the array.</p>
</div>
<div class="paragraph">
<p>If the value resolves to null the function result is a no-op.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="context-4"><a class="anchor" href="#context-4"></a>Context</h3>
<div class="paragraph">
<p>The function signals rejection by throwing an exception, so the rest of the sync function will not be run.</p>
</div>
<div class="paragraph">
<p>Note that <code>requireAccess()</code> will only recognize grants made explicitly using a channel name (not by a wildcard).</p>
</div>
<div class="paragraph">
<p>So, if a user was granted access using only the <a href="channels.html#lbl-all-channels" class="xref page">all channels wildcard</a>] (<code>*</code>), then <code>requireAccess('anychannelname')'</code> will fail because the user wasn&#8217;t granted access to that channel (only to the <code>*</code> channel).</p>
</div>
</div>
<div class="sect2">
<h3 id="use-4"><a class="anchor" href="#use-4"></a>Use</h3>
<div id="ex-requireaccess" class="exampleblock">
<div class="title">Example 4. requireAccess(channels)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">requireAccess("events"); <i class="conum" data-value="1"></i><b>(1)</b>

if (oldDoc) {
    requireAccess(oldDoc.channels); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Throw an exception unless the user has access to read the "events" channel:</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Throw an exception unless the user can read one of the channels in the previous revision&#8217;s <code>channels</code> property:</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-require-admin"><a class="anchor" href="#lbl-require-admin"></a>requireAdmin()</h2>
<div class="sectionbody">
<div id="lbl-require-admin" class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>requireAdmin()</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose-5"><a class="anchor" href="#purpose-5"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>requireAdmin()</code> function to reject document updates that are not made by the Sync Gateway Admin REST API.</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-5"><a class="anchor" href="#arguments-5"></a>Arguments</h3>
<div class="paragraph">
<p>There are no arguments.</p>
</div>
</div>
<div class="sect2">
<h3 id="use-5"><a class="anchor" href="#use-5"></a>Use</h3>
<div class="exampleblock">
<div class="title">Example 5. requireadmin</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">requireAdmin(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Throw an exception unless the request is sent to the Admin REST API</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-require-role"><a class="anchor" href="#lbl-require-role"></a>requireRole()</h2>
<div class="sectionbody">
<div id="lbl-require-role" class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>requireRole(rolename)</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose-6"><a class="anchor" href="#purpose-6"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>requireRole()</code> function to reject document updates that are not made by user with the specified role or roles, as shown in <a href="#ex-requirerole">Example 6</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-6"><a class="anchor" href="#arguments-6"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rolename</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Must be a string identifying a role, or an array of strings identifying multiple roles; the function is applied to each role in the array.</p>
</div>
<div class="paragraph">
<p>If the value resolves to null the function result is a no-op.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>&#8201;&#8212;&#8201;Role names must always be prefixed with <code>role:</code>; an exception is thrown if a role name doesn&#8217;t conform with this rule..</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="context-5"><a class="anchor" href="#context-5"></a>Context</h3>
<div class="paragraph">
<p>The function requires that the user has at least one of the specified roles.
If that is not the case it signals rejection by throwing an exception.
The rest of the sync function will not be run.</p>
</div>
</div>
<div class="sect2">
<h3 id="use-6"><a class="anchor" href="#use-6"></a>Use</h3>
<div id="ex-requirerole" class="exampleblock">
<div class="title">Example 6. requireRole(rolename)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">requireRole("admin"); <i class="conum" data-value="1"></i><b>(1)</b>

requireRole(["admin", "old-timer"]); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Throw an error unless the user has the "admin" role:</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Throw an error unless the user has one or more of those roles:</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-require-user"><a class="anchor" href="#lbl-require-user"></a>requireUser()</h2>
<div class="sectionbody">
<div id="lbl-require-user" class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>requireUser(username)</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose-7"><a class="anchor" href="#purpose-7"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>requireUser()</code> function to reject document updates that are not made by the specified user or users.</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-7"><a class="anchor" href="#arguments-7"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>username</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be a string identifying a user, or an array of strings identifying multiple users; the function is applied to each user in the array.</p>
<p class="tableblock">If the value resolves to null the function result is a no-op.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="context-6"><a class="anchor" href="#context-6"></a>Context</h3>
<div class="paragraph">
<p>The function signals rejection by throwing an exception, so the rest of the sync function will not be run.</p>
</div>
<div class="paragraph">
<p>When validating a document, you should treat all properties of the <code>doc</code> parameter as <em>untrusted</em>. That is because it <strong>is</strong> the object that you&#8217;re validating.
This may sound obvious, but it can be easy to make mistakes, like calling <code>requireUser(doc.owners)</code> instead of <code>requireUser(oldDoc.owners)</code>.</p>
</div>
<div class="paragraph">
<p>When using one document property to validate another, look up that property in <code>oldDoc</code>, not <code>doc</code>!</p>
</div>
</div>
<div class="sect2">
<h3 id="use-7"><a class="anchor" href="#use-7"></a>Use</h3>
<div id="ex-requireuser" class="exampleblock">
<div class="title">Example 7. requireUser(username)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">requireUser("snej"); <i class="conum" data-value="1"></i><b>(1)</b>

requireUser(["snej", "jchris", "tleyden"]); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Throw an error if the user is not "snej":</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Throw an error if user&#8217;s name is not in the list <code>username</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-role"><a class="anchor" href="#lbl-role"></a>role()</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>role(username, rolename)</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="lbl-role"><a class="anchor" href="#lbl-role"></a>Purpose</h3>
<div class="paragraph">
<p>Use the <code>role()</code> function to add a role to a user.
This indirectly gives them access to any channels assigned to that role.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Roles, like users, have to be explicitly created by an administrator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="arguments-8"><a class="anchor" href="#arguments-8"></a>Arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rolename</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Must be a string identifying a role, or an array of strings identifying multiple roles; the function is applied to each role in the array.</p>
</div>
<div class="paragraph">
<p>If the value resolves to null the function result is a no-op.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>&#8201;&#8212;&#8201;Role names must always be prefixed with <code>role:</code>; an exception is thrown if a role name doesn&#8217;t conform with this rule..</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>username</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be a string identifying a user, or an array of strings identifying multiple users; the function is applied to each user in the array.</p>
<p class="tableblock">If the value resolves to null the function result is a no-op.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="context-7"><a class="anchor" href="#context-7"></a>Context</h3>
<div class="paragraph">
<p>This function affects the user&#8217;s ability to revise documents, if the access function requires role membership to validate certain types of changes.
Its use is similar to <code>access</code>.</p>
</div>
<div class="paragraph">
<p>Nonexistent roles don&#8217;t cause an error, but have no effect on the user&#8217;s access privileges.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can create roles retrospectively.
As soon as a role is created, any pre-existing references to it take effect.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="use-8"><a class="anchor" href="#use-8"></a>Use</h3>
<div class="exampleblock">
<div class="title">Example 8. role(username, rolename)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">role ("jchris", "role:admin"); <i class="conum" data-value="1"></i><b>(1)</b>
role ("jchris", ["role:portlandians", "role:portlandians-owners"]); <i class="conum" data-value="2"></i><b>(2)</b>
role (["snej", "jchris", "traun"], "role:mobile"); <i class="conum" data-value="3"></i><b>(3)</b>
role ("ed", null);  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The role <code>admin</code> is assigned to the user</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Both the named roles are assigned to the user</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The role <code>mobile</code> is assigned to all the named users</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>No op</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-throw"><a class="anchor" href="#lbl-throw"></a>throw()</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Function</dt>
<dd>
<p>throw()</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="purpose-8"><a class="anchor" href="#purpose-8"></a>Purpose</h3>
<div class="paragraph">
<p>Use <code>throw()</code> to prevent a document from persisting or syncing to any other users.</p>
</div>
</div>
<div class="sect2">
<h3 id="arguments-9"><a class="anchor" href="#arguments-9"></a>Arguments</h3>
<div class="paragraph">
<p>No arguments</p>
</div>
</div>
<div class="sect2">
<h3 id="context-8"><a class="anchor" href="#context-8"></a>Context</h3>
<div class="paragraph">
<p>You enforce the validity of document structure by checking the necessary constraints and throwing an exception if they&#8217;re not met.</p>
</div>
<div class="paragraph">
<p>In validating a document, you&#8217;ll often need to compare the new revision to the old one, to check for illegal changes in state.
For example, some properties may be immutable after the document is created, or may be changeable only by certain users, or may only be allowed to change in certain ways.
That&#8217;s why the current document contents are given to the sync function, as the <code>oldDoc</code> parameter.</p>
</div>
<div class="paragraph">
<p>We recommend that you not create invalid documents in the first place.
As much as possible, your app logic and validation function should prevent invalid documents from being created locally.
The server-side sync function validation should be seen as a fail-safe and a guard against malicious access.</p>
</div>
</div>
<div class="sect2">
<h3 id="use-9"><a class="anchor" href="#use-9"></a>Use</h3>
<div id="ex-throw" class="exampleblock">
<div class="title">Example 9. throw(forbidden:)</div>
<div class="content">
<div class="paragraph">
<p>In this example the sync function disallows all writes to the database it is in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function(doc) {

   throw({forbidden: "read only!"}) <i class="conum" data-value="1"></i><b>(1)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The document update will be rejected with an HTTP 403 "Forbidden" error code, with the value of the <code>forbidden:</code> property being the HTTP status message.<br>
This is the preferred way to reject an update.</td>
</tr>
</table>
</div>
</div>
</div>
<hr>
<h5 id="" class="discrete"></h5>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content"><a class="anchor" href="#related-content"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id="-2"><a class="anchor" href="#-2"></a></h6>
<div class="ulist">
<div class="title">Learn more &#8230;&#8203;</div>
<ul>
<li>
<p><a href="sync-function-overview.html" class="xref page">Sync Function</a></p>
</li>
<li>
<p><a href="import-filter.html" class="xref page">Import filter</a></p>
</li>
<li>
<p><a href="configuration-schema-access-control.html" class="xref page">Access Control</a></p>
</li>
<li>
<p><a href="#rest-api-admin.html#/Access_Control/update_sync_function" class="xref unresolved">Add/Update Sync Function</a></p>
</li>
<li>
<p><a href="sync-function-overview.html" class="xref page">Sync Function Overview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-3"><a class="anchor" href="#-3"></a></h6>
<div class="ulist">
<div class="title">Reference material &#8230;&#8203;</div>
<ul>
<li>
<p><a href="rest-api.html" class="xref page">Public REST API</a></p>
</li>
<li>
<p><a href="rest-api-admin.html" class="xref page">Admin REST API</a></p>
</li>
<li>
<p><a href="rest-api-metrics.html" class="xref page">Metrics REST API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-4"><a class="anchor" href="#-4"></a></h6>
<div class="paragraph">
<div class="title">Community</div>
<p><a href="https://forums.couchbase.com/c/mobile/14">Mobile Forum</a> |
<a href="https://blog.couchbase.com/">Blog</a> |
<a href="https://blog.couchbase.com/category/couchbase-mobile/?ref=blog-menu">Blog (Mobile)</a> |
<a href="https://docs.couchbase.com/tutorials/">Tutorials</a></p>
</div>
<div class="ulist">
<div class="title">Sync Function Blogs</div>
<ul>
<li>
<p><a href="https://blog.couchbase.com/augment-your-sync-function-with-roles-in-couchbase-sync-gateway/">Using roles in sync functions</a></p>
</li>
<li>
<p><a href="https://blog.couchbase.com/data-synchronization-offline-first-apps-couchbase/">Tutorial: Getting Started with Data Synchronization using Couchbase Mobile for Offline-First Apps</a></p>
</li>
<li>
<p><a href="https://blog.couchbase.com/tag/sync-function/">Sync Function (category)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Mobile","components":["sync-gateway"],"url":"/home/mobile.html","latestVersions":{"sync-gateway":"3.0"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
