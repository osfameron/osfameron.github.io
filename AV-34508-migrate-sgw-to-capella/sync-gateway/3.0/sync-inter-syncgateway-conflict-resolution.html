<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Enhanced Conflict Resolution | Couchbase Capella Staging Docs</title>
<link rel="canonical" href="https://docs.stage.nonprod-project-avengers.com/sync-gateway/3.0/sync-inter-syncgateway-conflict-resolution.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<meta name="description" content="About conflict resolution in inter-Sync Gateway replication">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="sync-gateway">
<meta name="dcterms.identifier" content="3.0">
<meta name="page-url" content="/sync-gateway/3.0/sync-inter-syncgateway-conflict-resolution.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.stage.nonprod-project-avengers.com/cloud/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.stage.nonprod-project-avengers.com/cloud/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="2">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/hakimcassimally/couchbase/docs-sync-gateway/modules/ROOT/pages/sync-inter-syncgateway-conflict-resolution.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="index.html">Sync Gateway</a></li>
<li class="crumb">Sync</li>
<li class="crumb">Inter-Sync Gateway Replication</li>
<li class="crumb"><a href="sync-inter-syncgateway-conflict-resolution.html">Inter Syncgateway Conflict Resolution</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Enhanced Conflict Resolution</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>About conflict resolution in inter-Sync Gateway replication<br>
Introduces inter-Sync Gateway replication conflict resolution policies and behaviors</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><em>Related  topics</em>:  <a href="sync-inter-syncgateway-overview.html" class="xref page">Overview</a>  |  <a href="sync-inter-syncgateway-run.html" class="xref page">Run</a>  |  <a href="sync-inter-syncgateway-manage.html" class="xref page">Manage</a>  |  <a href="sync-inter-syncgateway-monitor.html" class="xref page">Monitor</a>  |  Conflict</p>
</div>
<div class="paragraph">
<p><em>Other Topics</em>: <a href="configuration-properties-legacy.html" class="xref page">Legacy Pre-3.0 Configuration</a> | <a href="rest-api-admin.html" class="xref page">Admin REST API</a></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Context Clarification</div>
<div class="paragraph">
<p>This content relates only to inter-Sync Gateway replication in Sync Gateway 2.8+.
For documentation on pre-2.8 inter-Sync Gateway replication (also known as SG Replicate)&#8201;&#8212;&#8201;see the documentation for the appropriate release.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="automatic-conflict-resolution"><a class="anchor" href="#automatic-conflict-resolution"></a>Automatic Conflict Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Inter-Sync Gateway <strong>pull</strong> replications support automatic conflict resolution by default (no conflict mode).</p>
</div>
<div class="paragraph">
<p>In <em>Pull</em> replications the <em>active</em> Sync Gateway detects and resolves conflicts based on its configured <a href="configuration-schema-database.html#database-replications-this_rep-conflict_resolution_type" class="xref page">conflict_resolution_type</a> and <em>conflict resolver policy</em>.
This policy will determine the <em>winner</em>  or return an error if it cannot.</p>
</div>
<div class="paragraph">
<p>Conflicts are <strong>not</strong> resolved in <strong>push</strong> replications though.
The passive end of the push simply detects and rejects any conflicting revisions (<code>409 Conflict</code> response).</p>
</div>
<div class="paragraph">
<p>Both approaches reflect the way conflicts are handled by Couchbase Lite clients.
Not surprising since in both instances Couchbase Lite is acting like the active node in an inter-sync gateway exchange.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Conflicts are only resolved during a <strong>pull</strong> replication.
If conflicts are likely, you should configure a <code>pushAndPull</code> replication when using Conflict Free mode.</p>
</div>
<div class="paragraph">
<p><em>Alternatively</em>: Run the replicator from the other side; flipping the direction (to <code>pull</code>) and the resolution policy (for example <code>localWins</code> becomes <code>remoteWins</code>).</p>
</div>
<div class="paragraph">
<p>See also&#8201;&#8212;&#8201;our blog post: <a href="https://blog.couchbase.com/document-conflicts-couchbase-mobile/">Document Conflicts &amp; Resolution in Couchbase Mobile</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For <a href="https://www.couchbase.com/products/editions">ENTERPRISE EDITION</a>, a custom conflict resolver policy is available, providing additional flexibility by allowing users to provide their own conflict resolution logic&#8201;&#8212;&#8201;see: <a href="#custom-conflict-resolution-ee">Inter Sync Gateway Sync -  Custom Conflict Resolution</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-conflict-resolution"><a class="anchor" href="#configure-conflict-resolution"></a>Configure Conflict Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Invoke automatic conflict resolution by specifying the required <em>conflict resolver policy</em> in the <a href="glossary.html#replication-definition" class="xref page">replication definition<span class="image"><img src="_images/icons/glossaryIconImage2.png" alt="glossary icon" width="14"></span></a>.
The specified policy is applied whenever a conflict is detected.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Using automatic conflict resolution</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_default"></a>default</p>
</li>
<li>
<p><a id="tabset1_localwins"></a>localWins</p>
</li>
<li>
<p><a id="tabset1_remotewins"></a>remoteWins</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_default">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"databases:"
  // other config as necessary
  "this_db:"
    // other config as necessary
    "sgreplicate_enabled": "true",
    "replications": [
        {
          "replication_id": "replication1",
          "direction": "push_and_pull",
          "continuous": true,
          "filter": "sync_gateway/bychannel",
          "query_params": [
              "channel1",
              "channel2"
          ],
          "conflict_resolution_type": "default",
          // other config as necessary
        }
    ]
// other config as necessary</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_localwins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"databases:"
  // other config as necessary
  "this_db:"
    // other config as necessary
    "sgreplicate_enabled": "true",
    "replications": [
        {
          "replication_id": "replication1",
          "direction": "push_and_pull",
          "continuous": true,
          "filter": "sync_gateway/bychannel",
          "query_params": [
              "channel1",
              "channel2"
          ],
          "conflict_resolution_type": "localWins",
          // other config as necessary
        }
    ]
// other config as necessary</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_remotewins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"databases:"
  // other config as necessary
  "this_db:"
    // other config as necessary
    "sgreplicate_enabled": "true",
    "replications": [
        {
          "replication_id": "replication1",
          "direction": "push_and_pull",
          "continuous": true,
          "filter": "sync_gateway/bychannel",
          "query_params": [
              "channel1",
              "channel2"
          ],
          "conflict_resolution_type": "remoteWins",
          // other config as necessary
        }
    ]
// other config as necessary</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom-conflict-resolution-ee"><a class="anchor" href="#custom-conflict-resolution-ee"></a>Build a Conflict Resolution Policy [EE]</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This content relates only to <a href="https://www.couchbase.com/products/editions">ENTERPRISE EDITION</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Custom conflict resolution is handled by the <em>active</em> Sync Gateway using a user-provided <a href="glossary.html#custom-conflict-resolver" class="xref page">custom conflict resolver<span class="image"><img src="_images/icons/glossaryIconImage2.png" alt="glossary icon" width="14"></span></a>. This Javascript function is embedded in the replication configuration.</p>
</div>
<div class="paragraph">
<p>The predefined conflict resolver policies are also available as Javascript functions that you can call from within that <em>custom_conflict_resolver</em> function
This is useful when you want to apply greater selectivity to the automatic conflict resolution process. For example, you want to apply a 'remote wins' policy only for a specific type of document - see the 'Use Policies' tab in <a href="#simple-conflict-resolvers">Example 5</a>.</p>
</div>
<div class="sect2">
<h3 id="conflict-resolution-approaches"><a class="anchor" href="#conflict-resolution-approaches"></a>Conflict Resolution Approaches</h3>
<div class="paragraph">
<p>There are two ways to handle conflicts in your custom_conflict_resolver, you can either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Choose a <em>winning</em> revision from among the conflicting revisions (see <a href="#simple-conflict-resolvers">Example 5</a>), or</p>
</li>
<li>
<p>Merge conflicting revision to create a new <em>winning</em> revision; losing revisions are tomb-stoned.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When creating a new revision, do not provide a <code>_rev</code> property.
A new revision ID will be generated.
Use <code>delete mergedDoc._rev</code> to invalidate the property.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, users should avoid overly-complex resolver logic that may impact performance.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="approaches-to-error-handling"><a class="anchor" href="#approaches-to-error-handling"></a>Approaches to Error Handling</h3>
<div class="paragraph">
<p>Your custom conflict resolver function should not terminate the replication when it encounters exceptions or errors.
Instead, you should log sufficient information to aid troubleshooting and recovery.</p>
</div>
<div class="paragraph">
<p>For example, your custom conflict resolver function should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Skip the document causing the issue</p>
</li>
<li>
<p>Log a suitable warning level message.
Include at least the skipped document&#8217;s Id and the sequence Id of the revision in error.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to log files when troubleshooting conflict resolution errors, to identify the document id and revision sequence in error.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Some Error Scenarios and Recommended Resolutions</div>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Unexpected data in the remote document</dt>
<dd>
<p>You should update the remote document to fix the issue.
Doing so will cause replication of the update.</p>
</dd>
<dt class="hdlist1">Unexpected data in the local document</dt>
<dd>
<p>You should update the local document to fix the issue.
This will not trigger a pull-replication.
Do a no-op-update <sup class="footnote" id="_footnote_fn-1">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> of the remote document, which will trigger replication and conflict resolution.</p>
</dd>
<dt class="hdlist1">Fault in conflict resolution javascript function</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Fix the Javascript logic and then either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do a <em>no op update</em> <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> of the remote document.
This triggers a pull replication and subsequent conflict resolution.</p>
</li>
<li>
<p>Reset the replication (using <code>_replicationstatus/reset</code> endpoint). Not recommended as it introduces significant duplicate processing in resyncing previously synced documents.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conflict-resolver-structure"><a class="anchor" href="#conflict-resolver-structure"></a>Conflict Resolver Structure</h3>
<div class="paragraph">
<p>Sync Gateway supports the use of Javascript functions to customize the sync process.
These functions are referenced from within the Sync Gateway Configuration and may be provided either as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An inline Javascript function</p>
</li>
<li>
<p>An external Javascript file</p>
</li>
<li>
<p>An external HTTP/HTTPS endpoint serving a JS function
<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can provide your conflict resolver as either an inline or external Javascript function.
You can learn more about the ($db.custom_conflict_resolver) property in the Configuration Schema Reference&#8201;&#8212;&#8201;see: <a href="configuration-schema-database.html#database-replications-this_rep-custom_conflict_resolver" class="xref page">custom_conflict_resolver</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sync&#160;gateway 3.x configuration of Javascript functions is done using the <a href="rest-api-admin.html" class="xref page">Admin REST API</a>; specifically the <a href="rest-api-admin.html#/Access_Control" class="xref page">Access Control</a> and <a href="rest-api-admin.html#/Database_Configuration/update_import_filter" class="xref page">/{db}/_config/import_filter</a> endpoints.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Prior to this, configuration was done within the database configuration file&#8201;&#8212;&#8201;see: <a href="#ex-jsfunc-opts">Example 3</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inline Javascript functions provided within the database configuration must be enclosed by a backtick pair (``).</p>
</li>
<li>
<p></p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>To use an external Javascript function for any of the eligible options, you need to specify the absolute path to the Javascript.
The format and content of the external Javascript is the same as that provided inline.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You must register a CA certificate for the appropriate server if external Javascript functions are hosted on HTTPS endpoints.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For testing purposes you may use the unsupported configuration option <code><a href="configuration-schema-database.html#database-unsupported-remote_config_tls_skip_verify     " class="xref page">unsupported.remote_config_tls_skip_verify</a></code>.
Setting this <code>true</code> will side-step essential security checks.
Do not use in Production deployments.
</td>
</tr>
</table>
</div>
</div>
</div>
</li>
</ul>
</div>
<div id="ex-jsfunc-opts" class="exampleblock">
<div class="title">Example 3. Configuring a Javascript Sync Function</div>
<div class="content">
<div class="paragraph">
<p>This example shows the different ways you might provide a Javascript Sync Function.
Although the example uses the Sync Function, the same approach applies wherever a Javascript function is valid (including with Import Filter, Webhook and Custom Conflict Resolver).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">curl -X PUT 'http://localhost:4985/db1/_config' \
--header 'Accept: application/json' \
--header 'Content-Type: application/json' \
--data-raw '{
         "sync": "/opt/couchbase-sync-gateway/sync.js" <i class="conum" data-value="1"></i><b>(1)</b>
      },
    }
}'


  curl -X PUT 'http://localhost:4985/db2/_config' \
--header 'Accept: application/json' \
--header 'Content-Type: application/json' \
--data-raw '{
         "sync": "https://localhost/sync/func2" <i class="conum" data-value="2"></i><b>(2)</b>
      }
   }
}


curl -X PUT 'http://localhost:4985/db3/_config' \
--header 'Accept: application/json' \
--header 'Content-Type: application/json' \
--data-raw '{
         "sync": `function(doc,oldDoc, meta){ if (doc.published) { channel("public");} }`
      } <i class="conum" data-value="3"></i><b>(3)</b>
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we specify an external file <code>sync.js</code> as containing the external function to be provisioned</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we specify a HTTPS endpoint as resolving to a Javascript function to be provisioned</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here we specify inline Javascript (surrounded by a pair of backticks (``) as the function to be provisioned</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows the basic structure of the conflict resolver function as it would be defined in the configuration file.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Conflict resolver structure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript" data-source-url="https://github.com/couchbase/docs-sync-gateway/blob/undefined/modules/ROOT/examples/configuration/sync-gateway-config.json">
"custom_conflict_resolver": "`function(conflict) { <i class="conum" data-value="1"></i><b>(1)</b>
  //  . . .
  //  . . . application logic to determine winner
  //  . . .
  return conflict.LocalDocument;  <i class="conum" data-value="2"></i><b>(2)</b>
  }`" <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>conflict</code> structure comprises both conflicting documents.
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">type Conflict struct {
  LocalDocument  Body `json:"LocalDocument"`
  RemoteDocument Body `json:"RemoteDocument"`
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">LocalDocument</dt>
<dd>
<p>This LocalDocument object encapsulates the body and metadata of the local conflicting document revision being replicated. Its content matches the JSON stored at the local Sync Gateway.</p>
</dd>
<dt class="hdlist1">RemoteDocument</dt>
<dd>
<p>The RemoteDocument object, encapsulates the body and metadata of the remote conflicting document revision being replicated. Its content matches the JSON stored at the remote Sync Gateway.</p>
</dd>
</dl>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You should return one of:
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>conflict.LocalDocument</p>
</li>
<li>
<p>conflict.RemoteDocument</p>
</li>
<li>
<p>a new document body comprising the merged local and remote documents</p>
</li>
<li>
<p>a <strong>nil</strong> body, which will be resolved as a <strong>delete</strong></p>
</li>
</ul>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The conflict resolver function is enclosed by backticks (<code>``</code>)</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-conflict-resolvers"><a class="anchor" href="#sample-conflict-resolvers"></a>Sample Conflict Resolvers</h3>
<div id="simple-conflict-resolvers" class="exampleblock">
<div class="title">Example 5. Simple conflict resolvers</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_use-built-in-policies"></a>Use Built-in Policies</p>
</li>
<li>
<p><a id="tabset2_nominate-a-winner"></a>Nominate a Winner</p>
</li>
<li>
<p><a id="tabset2_merge-a-winner"></a>Merge a Winner</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_use-built-in-policies">
<div class="paragraph">
<p>This example uses the built-in resolver functions to resolve the conflict based-on the document type.</p>
</div>
<div class="paragraph">
<p>So, documents of type <code>a-doc-type-1</code> are always resolved in favor of the remote revision. All other document types are resolved in accordance with the default resolver policy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="https://github.com/couchbase/docs-sync-gateway/blob/undefined/modules/ROOT/examples/configuration/sync-gateway-config.json">"replications": [
  {
  "replication_id": "replication1",
  // other config as required
  "conflict_resolution_type": "custom",
  "custom_conflict_resolver": `
    function(conflict) {
      if  (conflict.LocalDocument.type == "a-doctype-1") &amp;&amp;
          (conflict.RemoteDocument.type == "a-doctype-1")
       {
         // Invoke the built in default resolver logic
         return defaultPolicy(conflict);
       }
      else {
        // Otherwise resolve in favor of remote document
          return conflict.RemoteDocument;
        }
    }
    `
  // other config as required
  }
]</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_nominate-a-winner">
<div class="paragraph">
<p>This example selects a winner based on relative priorities and builds a return response of its own rather than using either the localWins or remoteWins policy, although it does rely on the default resolver policy as a backstop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="https://github.com/couchbase/docs-sync-gateway/blob/undefined/modules/ROOT/examples/configuration/sync-gateway-config.json">"replications": [
  {
    // . . . preceding replication details as required
  },
  {
    "replication_id": "replication2",
    // . . .   other config as required
    "conflict_resolution_type": "custom",
    "custom_conflict_resolver": `
      function(conflict) {
        // Custom conflict resolution policy based on priority
        if (conflict.LocalDocument.body.priority &gt; conflict.RemoteDocument.body.priority) {
          // Choose a local winner
          // Optionally apply application logic to manipulate
          // the local object before returning it as the winner
          return conflict.LocalDocument;
        } else if (local.body.priority &lt; remote.body.priority) {
            // Choose a remote winner
            // Optionally apply application logic to manipulate
            // the remote object before returning it as the winner
          return conflict.RemoteDocument;
          }; //end if
        } //end func()
        // Apply the default policy as a catch all
        return defaultPolicy(conflict);
    }` // end resolver property
  }, // end replication2
  {
    // . . . further replication details as required
  }
]
// . . .   other config as required</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_merge-a-winner">
<div class="paragraph">
<p>This example creates a winner by merging changes from the local and remote documents to create a new document object, which is returned as the winner.</p>
</div>
<div class="paragraph">
<p>If both document.types are non-null and the local document.type is <code>usedefault</code>, the merge path is overridden and the default resolver policy is applied.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="https://github.com/couchbase/docs-sync-gateway/blob/undefined/modules/ROOT/examples/configuration/sync-gateway-config.json">"custom_conflict_resolver":`
  function(conflict) {
      if (  (conflict.LocalDocument.type != null) &amp;&amp;
            (conflict.RemoteDocument.type != null) &amp;&amp;
            (conflict.LocalDocument.type == "usedefault"))
      {
          console.log("Will use default policy");
          // Resolve using built-in policy
          return defaultPolicy(conflict);
      }
      else
      {
        // Merge local and remote docs
        var remoteDoc = conflict.RemoteDocument;
        console.log("full remoteDoc doc: "+JSON.stringify(remoteDoc));
        var localDoc = conflict.LocalDocument;
        console.log("full localDoc doc: "+JSON.stringify(localDoc));
        var mergedDoc = extend({}, localDoc, remoteDoc);
        delete mergedDoc._rev <i class="conum" data-value="1"></i><b>(1)</b>

        console.log("full mergedDoc doc: "+JSON.stringify(mergedDoc));
        // Resolve using this merged doc as the winner
        return mergedDoc;

        function extend(target) {
            var sources = [].slice.call(arguments, 1);
            sources.forEach(function (source) {
                for (var prop in source) {
                  if (prop.indexOf('_') != 0) { <i class="conum" data-value="2"></i><b>(2)</b>
                    target[prop] = source[prop];
                  }
                }
            });
            return target;
        } // end function extend()
      } // end if
  }` // end function()</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Invalidate the <code>_rev</code> property.
A new revision ID will be generated.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Transcribe properties from source to target.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>IF</code> block is temporary. It circumvents the known_issue <a href="https://issues.couchbase.com/browse/CBG-1335">CBG-1335</a>, which results in a revision ID mismatch.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<hr>
<h5 id="" class="discrete"></h5>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content"><a class="anchor" href="#related-content"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id="-2"><a class="anchor" href="#-2"></a></h6>
<div class="ulist">
<div class="title">Learn more &#8230;&#8203;</div>
<ul>
<li>
<p><a href="sync-inter-syncgateway-overview.html" class="xref page">Inter Sync Gateway Sync - Overview</a></p>
</li>
<li>
<p><a href="sync-with-couchbase-server.html" class="xref page">Sync with Couchbase Server</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-3"><a class="anchor" href="#-3"></a></h6>
<div class="ulist">
<div class="title">Reference material &#8230;&#8203;</div>
<ul>
<li>
<p><a href="configuration-schema-bootstrap.html" class="xref page">Bootstrap</a></p>
</li>
<li>
<p><a href="configuration-schema-database.html" class="xref page">Database</a></p>
</li>
<li>
<p><a href="configuration-schema-db-security.html" class="xref page">Database Security</a></p>
</li>
<li>
<p><a href="configuration-schema-access-control.html" class="xref page">Access Control</a></p>
</li>
<li>
<p><a href="configuration-schema-import-filter.html" class="xref page">Import Filter</a></p>
</li>
<li>
<p><a href="configuration-schema-isgr.html" class="xref page">Inter-Sync&#160;Gateway Replication</a></p>
</li>
<li>
<p><a href="configuration-properties-legacy.html" class="xref page">Legacy Pre-3.0 Configuration</a></p>
</li>
<li>
<p><a href="rest-api.html" class="xref page">Public REST API</a></p>
</li>
<li>
<p><a href="rest-api-admin.html" class="xref page">Admin REST API</a></p>
</li>
<li>
<p><a href="rest-api-metrics.html" class="xref page">Metrics REST API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-4"><a class="anchor" href="#-4"></a></h6>
<div class="paragraph">
<div class="title">Community</div>
<p><a href="https://forums.couchbase.com/c/mobile/14">Mobile Forum</a> |
<a href="https://blog.couchbase.com/">Blog</a> |
<a href="https://blog.couchbase.com/category/couchbase-mobile/?ref=blog-menu">Blog (Mobile)</a> |
<a href="https://docs.couchbase.com/tutorials/">Tutorials</a></p>
</div>
<div class="ulist">
<div class="title">Conflict Related Blogs</div>
<ul>
<li>
<p><a href="https://blog.couchbase.com/document-conflicts-couchbase-mobile/">Automatic Conflict Resolution</a></p>
</li>
<li>
<p><a href="https://blog.couchbase.com/conflict-resolution-couchbase-mobile/">Demystifying Conflict Resolution</a></p>
</li>
<li>
<p><a href="https://blog.couchbase.com/tag/conflict-resolution/">Conflict Resolution (category)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. No-op update&#8201;&#8212;&#8201;refers to a change to the document body that has no impact on the app logic but will trigger an import by the Sync Gateway. One option could be to include a property used specifically for this purpose (i.e. a counter that can be incremented in response to conflict resolver errors).
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Sync Gateway 3.x
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Mobile","components":["sync-gateway"],"url":"/home/mobile.html","latestVersions":{"sync-gateway":"3.0"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
