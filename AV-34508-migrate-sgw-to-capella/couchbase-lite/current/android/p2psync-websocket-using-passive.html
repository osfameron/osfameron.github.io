<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Passive Peer | Couchbase Docs</title>
<link rel="canonical" href="https://docs.couchbase.com/couchbase-lite/current/android/p2psync-websocket-using-passive.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Lite&#x27;s Peer-to-Peer Synchronization enables edge devices to synchronize securely without consuming centralized cloud-server resources">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="3.0">
<meta name="page-url" content="/couchbase-lite/current/android/p2psync-websocket-using-passive.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a href="https://cloud.couchbase.com/sign-up" class="free-trial-link" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  <i class="fas fa-cloud"></i>
                  Free Trial
                </a>
                <a class="btn btn-primary try-btn"  onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
<div class="components">
  <div class="components_group-title">
    <a href="../../../home/mobile.html">Mobile</a>
  </div>
  <ul class="components_list">
    <li class="components_list-items">
      <div class="component_list-version">
        <span class="component_list_title">Couchbase Lite</span>
        <select class="version_list" data-component="couchbase-lite">
          <option value="3.0" data-url="../index.html" selected>3.0</option>
        </select>
      </div>
      <div class="version_items hide" data-version="3.0">
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../index.html">Introduction</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbl-whatsnew.html">New in 3.0</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="quickstart.html">Android</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="gs-prereqs.html">Prerequisites</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="kotlin.html">Kotlin</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="querybuilder.html">Querybuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-n1ql-mobile.html">SQL++ for Mobile</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-n1ql-mobile-server-diffs.html">SQL++ Server Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-n1ql-mobile-querybuilder-diffs.html">SQL++ Querybuilder Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Data Sync</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="dbreplica.html">Intra-device Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-current-page" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link is-current-page" href="p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/">API References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android-ktx">Kotlin Extensions</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="supported-os.html">Supported Platforms</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../c/quickstart.html">C</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/gs-downloads.html">Download</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/c_fleece.html">Fleece API</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/field-level-encryption.html">Field Level Encryption</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/query-n1ql-mobile.html">SQL++ for Mobile</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/query-n1ql-mobile-server-diffs.html">SQL++ Server Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/replication.html">Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-c/">API&#160;References</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../c/supported-os.html">Supported Platforms</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../csharp/quickstart.html">.Net</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/querybuilder.html">Querybuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/query-n1ql-mobile.html">SQL++ for Mobile</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/query-n1ql-mobile-server-diffs.html">SQL++ Mobile - Server Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/query-n1ql-mobile-querybuilder-diffs.html">SQL++ Querybuilder Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Data Sync</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/dbreplica.html">Intra-device Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../csharp/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-net/index.html">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../csharp/supported-os.html">Supported Platforms</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../java/quickstart.html">Java</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/gs-prereqs.html">Prerequisites</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/querybuilder.html">Querybuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-n1ql-mobile.html">SQL++ for Mobile</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-n1ql-mobile-server-diffs.html">SQL++ Server Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-n1ql-mobile-querybuilder-diffs.html">SQL++ Querybuilder Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Data Sync</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/dbreplica.html">Intra-device Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../java/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-java/">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/supported-os.html">Supported Platforms</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../javascript/quickstart.html">Javascript</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../javascript/ionic.html">Ionic</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../javascript/cordova.html">Cordova</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../javascript/react.html">React Native</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/quickstart.html">Objective-C</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/gs-prereqs.html">Prerequisites</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/querybuilder.html">Querybuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-n1ql-mobile.html">SQL++ for Mobile</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-n1ql-mobile-server-diffs.html">SQL++ Server Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-n1ql-mobile-querybuilder-diffs.html">SQL++ Querybuilder Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/dbreplica.html">Intra-device Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-objc/index.html">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/troubleshooting-crashes.html">Troubleshooting Crashes</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/supported-os.html">Supported Platforms</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../swift/quickstart.html">Swift</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/gs-prereqs.html">Prerequisites</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/querybuilder.html">Querybuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-n1ql-mobile.html">SQL++ for Mobile</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-n1ql-mobile-server-diffs.html">SQL++ Server Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-n1ql-mobile-querybuilder-diffs.html">SQL++ Querybuilder Differences</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="#swift:landing-replications.adoc">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/dbreplica.html">Intra-device Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../swift/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://docs.couchbase.com/mobile/3.0.2/couchbase-lite-swift/index.html">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/troubleshooting-crashes.html">Troubleshooting Crashes</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/supported-os.html">Supported Platforms</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
</ul>
      </div>
    </li>
  </ul>
</div>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="2">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/hakimcassimally/couchbase/docs-couchbase-lite/modules/android/pages/p2psync-websocket-using-passive.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../index.html">Couchbase Lite</a></li>
<li class="crumb"><a href="quickstart.html">Android</a></li>
<li class="crumb">Data Sync</li>
<li class="crumb"><a href="p2psync-websocket.html">Peer-to-Peer</a></li>
<li class="crumb"><a href="p2psync-websocket-using-passive.html">Passive Peer</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Passive Peer</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Description&#8201;&#8212;&#8201;<em>Couchbase Lite&#8217;s Peer-to-Peer Synchronization enables edge devices to synchronize securely without consuming centralized cloud-server resources</em><br>
<em>Abstract&#8201;&#8212;&#8201;How to set up a Listener to accept a Replicator connection and sync using peer-to-peer</em><br>
Related Content&#8201;&#8212;&#8201;<a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/">API Reference</a>  |  <a href="p2psync-websocket-using-passive.html" class="xref page">Passive Peer</a>  |  <a href="p2psync-websocket-using-active.html" class="xref page">Active Peer</a></p>
</div>
</blockquote>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Android enablers</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allow Unencrypted Network Traffic</dt>
<dd>
<p>To use cleartext, un-encrypted, network traffic (<code>http://</code> and-or <code>ws://</code>),  include <code>android:usesCleartextTraffic="true"</code> in the <code>application</code> element of the manifest as shown on <a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted" target="_blank" rel="noopener">android.com</a>.<br>
<strong>This not recommended in production</strong>.</p>
</dd>
<dt class="hdlist1">Use Background Threads</dt>
<dd>
<p>As with any network or file I/O activity, CouchbaseLite activities should not be performed on the UI thread.
<strong>Always</strong> use a <strong>background</strong> thread.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Code Snippets</div>
All code examples are indicative only.
They demonstrate the basic concepts and approaches to using a feature.
Use them as inspiration and adapt these examples to best practice when developing applications for your platform.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This content provides code and configuration examples covering the implementation of <a href="refer-glossary.html#peer-to-peer-sync" class="xref page">Peer-to-Peer Sync</a> over websockets.
Specifically it covers the implementation of a <a href="refer-glossary.html#passive-peer" class="xref page">Passive Peer</a>.</p>
</div>
<div class="paragraph">
<p>This <em>passive peer</em> (also referred to as the server, or listener) will accept a connection from an <a href="refer-glossary.html#active-peer" class="xref page">Active Peer</a> (also referred to as the client or replicator) and participate in the replication of database changes to synchronize both databases.</p>
</div>
<div class="paragraph">
<p>Subsequent sections provide additional details, and examples for the main configuration options.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Secure Storage</div>
The use of TLS, its associated keys and certificates requires using secure storage to minimize the chances of a security breach.
The implementation of this storage differs from platform to platform&#8201;&#8212;&#8201;see <a href="p2psync-websocket.html#using-secure-storage" class="xref page">Using secure storage</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-summary"><a class="anchor" href="#configuration-summary"></a>Configuration Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You should configure and initialize a listener for each Couchbase Lite database instance you want to sync.
There is no limit on the number of listeners you may configure&#8201;&#8212;&#8201;<a href="#simple-listener-initialization">Example 1</a> shows a simple initialization and configuration process.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You must include the initializer <code>CouchbaseLite.init(context)</code> such that it is executed (once only) prior to initializing the replicator; for example in your app&#8217;s <code>onCreate()</code> method.
</td>
</tr>
</table>
</div>
<div id="simple-listener-initialization" class="exampleblock">
<div class="title">Example 1. Listener configuration and initialization</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset1_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">val listener = URLEndpointListener(
    URLEndpointListenerConfigurationFactory.create(
        database = database, <i class="conum" data-value="1"></i><b>(1)</b>
        port = 55990, <i class="conum" data-value="2"></i><b>(2)</b>
        networkInterface = "10.1.1.10", <i class="conum" data-value="3"></i><b>(3)</b>

        enableDeltaSync = false, <i class="conum" data-value="4"></i><b>(4)</b>

        // Configure server security
        disableTls = false, <i class="conum" data-value="5"></i><b>(5)</b>

        // Use an Anonymous Self-Signed Cert
        identity = null, <i class="conum" data-value="6"></i><b>(6)</b>

        // Configure Client Security using an Authenticator
        // For example, Basic Authentication <i class="conum" data-value="7"></i><b>(7)</b>
        authenticator = ListenerPasswordAuthenticator { username, paassword -&gt;
            (username === validUser) &amp;&amp; (paassword === validPassword)
        }
    ))

// Start the listener
listener.start() <i class="conum" data-value="8"></i><b>(8)</b>
thisListener = listener</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">// Initialize the listener config
final URLEndpointListenerConfiguration thisConfig
   = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="1"></i><b>(1)</b>

thisConfig.setPort(55990); <i class="conum" data-value="2"></i><b>(2)</b>

thisConfig.setNetworkInterface("10.1.1.10"); <i class="conum" data-value="3"></i><b>(3)</b>

thisConfig.setEnableDeltaSync(false); <i class="conum" data-value="4"></i><b>(4)</b>

// Configure server security
thisConfig.setDisableTls(false); <i class="conum" data-value="5"></i><b>(5)</b>

// Use an Anonymous Self-Signed Cert
thisConfig.setTlsIdentity(null); <i class="conum" data-value="6"></i><b>(6)</b>


// Configure Client Security using an Authenticator
// For example, Basic Authentication <i class="conum" data-value="7"></i><b>(7)</b>
thisConfig.setAuthenticator(new ListenerPasswordAuthenticator(
  (validUser, validPassword) -&gt;
    username.equals(validUser) &amp;&amp;
    Arrays.equals(password, validPassword)));

// Initialize the listener
final URLEndpointListener thisListener
  = new URLEndpointListener(thisConfig); <i class="conum" data-value="8"></i><b>(8)</b>

// Start the listener
thisListener.start(); <i class="conum" data-value="9"></i><b>(9)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Identify the local database to be used&#8201;&#8212;&#8201;see: <a href="#initialize-the-listener-configuration">Initialize the Listener Configuration</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optionally, choose a port to use.
By default the system will automatically assign a port&#8201;&#8212;&#8201;to over-ride this, see: <a href="#lbl-set-network-and-port">Set Port and Network Interface</a></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Optionally, choose a network-interface to use.
By default the system will listen on all network interfaces&#8201;&#8212;&#8201;to over-ride this see: <a href="#lbl-set-network-and-port">Set Port and Network Interface</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally, choose to sync only changes, the default is not to enable delta-sync&#8201;&#8212;&#8201;see: <a href="#delta-sync">Delta Sync</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set server security.
TLS is always enabled out-of-the-box, so you can usually omit this line.
But you <em>can</em>, optionally, disable TLS (<strong>not</strong> advisable in production)&#8201;&#8212;&#8201;see: <a href="#lbl-tls-security">TLS Security</a></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the credentials this server will present to the client for authentication.
Here we show the default TLS authentication, which is by anonymous self-signed certificate.
The server must always authenticate itself to the client.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Set client security&#8201;&#8212;&#8201;define the credentials the server expects the client to present for authentication.
Here we show how basic authentication is configured to authenticate the client-supplied credentials from the http authentication header against valid credentials&#8201;&#8212;&#8201;see <a href="#lbl-authenticating-the-client">Authenticating the Client</a> for more options.<br>
Note that client authentication is optional.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Initialize the listener using the configuration settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><a href="#lbl-start-listener">Start Listener</a></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-references"><a class="anchor" href="#api-references"></a>API References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/">Android API References</a> here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="device-discovery"><a class="anchor" href="#device-discovery"></a>Device Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>This phase is optional:</strong> If the listener is initialized on a well known URL endpoint (for example, a static IP Address or well known DNS address) then you can configure active peers to connect to those.</p>
</div>
<div class="paragraph">
<p>Prior to initiating the listener you may execute a peer discovery phase.
For the passive peer, this involves advertising the service using, for example
<em>Network Service Discovery</em> (see: <a href="https://developer.android.com/training/connect-devices-wirelessly/nsd" class="bare">https://developer.android.com/training/connect-devices-wirelessly/nsd</a>)
 and waiting for an invite from the active peer.
The connection is established once the passive peer has authenticated and accepted an active peer&#8217;s invitation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initialize-the-listener-configuration"><a class="anchor" href="#initialize-the-listener-configuration"></a>Initialize the Listener Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Initialize the listener configuration with the local database&#8201;&#8212;&#8201;see <a href="#ex-locdb">Example 2</a>
All other configuration values take their default setting.</p>
</div>
<div class="paragraph">
<p>Each Listener instance serves one Couchbase Lite database.
Couchbase sets no hard limit on the number of listeners you can initialize.</p>
</div>
<div id="ex-locdb" class="exampleblock">
<div class="title">Example 2. Specify Local Database</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset2_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">database = database, <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">// Initialize the listener config
final URLEndpointListenerConfiguration thisConfig
   = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the local database using the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html">URLEndpointListenerConfiguration</a>'s constructor <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#URLEndpointListenerConfiguration-com.couchbase.lite.Database-">(Database database)</a>.<br>
The database must be opened before the listener is started.<br>
<code>thisDB</code> has previously been declared as an object of type <code>Database</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-set-network-and-port"><a class="anchor" href="#lbl-set-network-and-port"></a>Set Port and Network Interface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="port-number"><a class="anchor" href="#port-number"></a>Port number</h3>
<div class="paragraph">
<p>The Listener will automatically select an available port if you do not specify one&#8201;&#8212;&#8201;see <a href="#ex-port">Example 3</a> for how to specify a port.</p>
</div>
<div id="ex-port" class="exampleblock">
<div class="title">Example 3. Specify a port</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset3_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">port = 55990, <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">thisConfig.setPort(55990); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To use a canonical port&#8201;&#8212;&#8201;one known to other applications&#8201;&#8212;&#8201;specify it explicitly using the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setPort-int-">setPort</a> method shown here.<br>
Ensure that any port you do specify is not blocked by firewall rules.<br>
You can query the port using <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#getPort-int-">getPort</a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="network-interface"><a class="anchor" href="#network-interface"></a>Network Interface</h3>
<div class="paragraph">
<p>The Listener will listen on all network interfaces by default.</p>
</div>
<div id="specify-a-network-interface-to-use" class="exampleblock">
<div class="title">Example 4. Specify a Network Interface to Use</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset4_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">networkInterface = "10.1.1.10", <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">thisConfig.setNetworkInterface("10.1.1.10"); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To specify an interface&#8201;&#8212;&#8201;one known to other applications&#8201;&#8212;&#8201;identify it explicitly, using the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setNetworkInterface-java.lang.String-">setNetworkInterface</a> method shown here.
This must be either an IP Address or network interface name such as <code>en0</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="delta-sync"><a class="anchor" href="#delta-sync"></a>Delta Sync</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Delta Sync allows clients to sync only those parts of a document that have changed.
This can result in significant savings in bandwidth consumption as well as throughput improvements.
Both valuable benefits, especially when network bandwidth is constrained.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Enable delta sync</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset5_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">enableDeltaSync = false, <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">thisConfig.setEnableDeltaSync(false); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Delta sync replication is not enabled by default.
Use <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html">URLEndpointListenerConfiguration</a>'s <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setEnableDeltaSync-boolean-">setEnableDeltaSync</a> method to activate or deactivate it.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-tls-security"><a class="anchor" href="#lbl-tls-security"></a>TLS Security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="enable-or-disable-tls"><a class="anchor" href="#enable-or-disable-tls"></a>Enable or Disable TLS</h3>
<div class="paragraph">
<p>Define whether the connection is to use TLS or clear text.</p>
</div>
<div class="paragraph">
<p>TLS based encryption is enabled by default and this setting ought to be used in any production environment.
However, it <em>can</em> be disabled, for example for development and-or test environments.</p>
</div>
<div class="paragraph">
<p>When TLS is enabled, Couchbase Lite provides several options on how the Listener may be configured with an appropriate TLS Identity&#8201;&#8212;&#8201;see <a href="#configure-tls-identity-for-listener">Configure TLS Identity for Listener</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To use cleartext, un-encrypted, network traffic (<code>http://</code> and-or <code>ws://</code>),  include <code>android:usesCleartextTraffic="true"</code> in the <code>application</code> element of the manifest as shown on <a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted" target="_blank" rel="noopener">android.com</a>.<br>
<strong>This not recommended in production</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html">URLEndpointListenerConfiguration</a>'s <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setDisableTls-boolean-">setDisableTLS</a> method to disable TLS communication if necessary</p>
</div>
<div class="paragraph">
<p>The <code>disableTLS</code> setting must be 'false' when <em>Client Cert Authentication</em> is required.</p>
</div>
<div class="paragraph">
<p>Basic Authentication can be used with, or without, TLS.</p>
</div>
<div class="paragraph">
<p><a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setDisableTls-boolean-">setDisableTLS</a> works in conjunction with <code>TLSIdentity</code>, to enable developers to define the key and certificate to be used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>disableTLS</code> is true&#8201;&#8212;&#8201;TLS communication is disabled and TLS identity is ignored.
Active peers will use the <code>ws://</code> URL scheme used to connect to the listener.</p>
</li>
<li>
<p>If <code>disableTLS</code> is false or not specified&#8201;&#8212;&#8201;TLS communication is enabled.</p>
<div class="paragraph">
<p>Active peers will use the <code>wss://</code> URL scheme to connect to the listener.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configure-tls-identity-for-listener"><a class="anchor" href="#configure-tls-identity-for-listener"></a>Configure TLS Identity for Listener</h3>
<div class="paragraph">
<p>Define the credentials the server will present to the client for authentication.
Note that the server must always authenticate itself with the client&#8201;&#8212;&#8201;see: <a href="p2psync-websocket-using-active.html#authenticate-listener" class="xref page">Authenticate Listener on Active Peer</a> for how the client deals with this.</p>
</div>
<div class="paragraph">
<p>Use <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html">URLEndpointListenerConfiguration</a>'s
<a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setTlsIdentity-com.couchbase.lite.TLSIdentity-">setTlsIdentity</a> method to configure the TLS Identity used in TLS communication.</p>
</div>
<div class="paragraph">
<p>If <code>TLSIdentity</code> is not set, then the listener uses an auto-generated anonymous self-signed identity (unless <code>disableTLS = true</code>).
Whilst the client cannot use this to authenticate the server, it will use it to encrypt communication, giving a more secure option than non-TLS communication.</p>
</div>
<div class="paragraph">
<p>The auto-generated anonymous self-signed identity is saved in secure storage for future use to obviate the need to re-generate it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Typically, you will configure the listener&#8217;s TLS Identity once during initial launch and re-use it (from secure storage on any subsequent starts.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here are some example code snippets showing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setting TLS identity to expect self-signed certificate&#8201;&#8212;&#8201;&#8201;&#8212;&#8201;see: <a href="#ex-create-tls-id">Example 6</a></p>
</li>
<li>
<p>Setting TLS identity to expect anonymous certificate&#8201;&#8212;&#8201;see: <a href="#ex-anon-tls-id">Example 7</a></p>
</li>
</ul>
</div>
<div id="ex-create-tls-id" class="exampleblock">
<div class="title">Example 6. Create Self-Signed Cert</div>
<div class="content">
<div class="paragraph">
<p>Create a TLSIdentity for the server using convenience API. The system generates a self-signed certificate.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset6_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">        disableTls = false, <i class="conum" data-value="1"></i><b>(1)</b>


// Set the TLS Identity
URLEndpointListenerConfigurationFactory.create(
    database,
    identity = TLSIdentity.getIdentity("test-alias")
) <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">  thisConfig.setDisableTls(false); <i class="conum" data-value="1"></i><b>(1)</b>


// Use a self-signed certificate
// Create a TLSIdentity for the server using convenience API.
// System generates self-signed cert
// Work-in-progress. Code snippet coming soon.
private static final Map&lt;String, String&gt; CERT_ATTRIBUTES; <i class="conum" data-value="2"></i><b>(2)</b>
static {
  final Map&lt;String, String&gt; thisMap = new HashMap&lt;&gt;();
  m.put(TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME, "Couchbase Demo");
  m.put(TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION, "Couchbase");
  m.put(TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT, "Mobile");
  m.put(TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS, "<a href="mailto:noreply@couchbase.com">noreply@couchbase.com</a>");
  CERT_ATTRIBUTES = Collections.unmodifiableMap(thisMap);
}

// Store the TLS identity in secure storage
// under the label 'couchbase-docs-cert'
TLSIdentity thisIdentity =
  new TLSIdentity.createIdentity(
    true,
    CERT_ATTRIBUTES,
    null,
    "couchbase-docs-cert"); <i class="conum" data-value="3"></i><b>(3)</b>


// Set the TLS Identity
thisConfig.setTlsIdentity(thisIdentity); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ensure TLS is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Map the required certificate attributes, in this case the common name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the required TLS identity using the attributes.
Add to secure storage as 'couchbase-docs-cert'.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure the server to present the defined identity credentials when prompted.</td>
</tr>
</table>
</div>
<div id="ex-anon-tls-id" class="exampleblock">
<div class="title">Example 7. Use Anonymous Self-Signed Certificate</div>
<div class="content">
<div class="paragraph">
<p>This example uses an <em>anonymous</em> self signed certificate. Generated certificates are held in secure storage.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset7_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">disableTls = false, <i class="conum" data-value="1"></i><b>(1)</b>

// Use an Anonymous Self-Signed Cert
identity = null, <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset7_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">thisConfig.setDisableTls(false); <i class="conum" data-value="1"></i><b>(1)</b>

// Use an Anonymous Self-Signed Cert
thisConfig.setTlsIdentity(null); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ensure TLS is used.<br>
This is the default setting.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Authenticate using an anonymous self-signed certificate.<br>
This is the default setting.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-authenticating-the-client"><a class="anchor" href="#lbl-authenticating-the-client"></a>Authenticating the Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section: <a href="#use-basic-authentication">Use Basic Authentication</a>  |  <a href="#using-client-certificate-authentication">Using Client Certificate Authentication</a>  |  <a href="#delete-tls-identity">Delete Entry</a>  |  <a href="#the-impact-of-tls-settings">The Impact of TLS Settings</a></p>
</div>
<div class="paragraph">
<p>Define how the server (listener) will authenticate the client as one it is prepared to interact with.</p>
</div>
<div class="paragraph">
<p>Whilst client authentication is optional, Couchbase lite provides the necessary tools to implement it.
Use the
<a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html">URLEndpointListenerConfiguration</a> class&#8217;s <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListenerConfiguration.html#setAuthenticator-com.couchbase.lite.ListenerAuthenticator-">setAuthenticator</a> method to specify how the client-supplied credentials are to be authenticated.</p>
</div>
<div class="paragraph">
<p>Valid options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No authentication&#8201;&#8212;&#8201;If you do not define an Authenticator then all clients are accepted.</p>
</li>
<li>
<p>Basic Authentication&#8201;&#8212;&#8201;uses the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/ListenerPasswordAuthenticator.html">ListenerPasswordAuthenticator</a> to authenticate the client using the client-supplied username and password (from the http authentication header).</p>
</li>
<li>
<p><a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/ListenerCertificateAuthenticator.html">ListenerCertificateAuthenticator</a>&#8201;&#8212;&#8201;which authenticates the client using a client supplied chain of one or more certificates.
You should initialize the authenticator using one of the following constructors:</p>
<div class="ulist">
<ul>
<li>
<p>A list of one or more root certificates&#8201;&#8212;&#8201;the client supplied certificate must end at a certificate in this list if it is to be authenticated</p>
</li>
<li>
<p>A block of code that assumes total responsibility for authentication&#8201;&#8212;&#8201;it must return a boolean response (true for an authenticated client, or false for a failed authentication).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="use-basic-authentication"><a class="anchor" href="#use-basic-authentication"></a>Use Basic Authentication</h3>
<div class="paragraph">
<p>Define how to authenticate client-supplied username and password credentials.
To use client-supplied certificates instead&#8201;&#8212;&#8201;see: <a href="#using-client-certificate-authentication">Using Client Certificate Authentication</a></p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Password authentication</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset8_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset8_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset8_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">                // Configure Client Security using an Authenticator
                // For example, Basic Authentication <i class="conum" data-value="1"></i><b>(1)</b>
                authenticator = ListenerPasswordAuthenticator { username, paassword -&gt;
                    (username === validUser) &amp;&amp; (paassword === validPassword)
                }
            ))

        // Start the listener
        listener.start() <i class="conum" data-value="2"></i><b>(2)</b>
        thisListener = listener

    }

    fun ibListenerGetNetworkInterfaces() {
        val listener = URLEndpointListener(URLEndpointListenerConfigurationFactory.create(database = database))
        listener.start()
        Log.i(TAG, "URLS are ${listener.urls}")
        thisListener = listener
    }

    fun ibListenerLocalDb() {
        // . . . preceding application logic . . .
        CouchbaseLite.init(context) <i class="conum" data-value="3"></i><b>(3)</b>
        val thisDB = Database("passivepeerdb")
    }

    fun ibListenerConfigTlsDisable() {
        URLEndpointListenerConfigurationFactory.create(database, disableTls = false) <i class="conum" data-value="4"></i><b>(4)</b>
    }


    // !!! USERS SHOULD BE CAUTIONED THAT THIS IS INSECURE
    // Android has much better ways of importing keys
    fun ibListenerConfigTlsIdFull() {
        // Use CA Cert
        // Import a key pair into secure storage
        // Create a TLSIdentity from the imported key-pair

        this.javaClass.getResourceAsStream("serverkeypair.p12")?.use { <i class="conum" data-value="5"></i><b>(5)</b>
            KeyStoreUtils.importEntry(
                "teststore.p12",  // KeyStore type, eg: "PKCS12"
                it,  // An InputStream from the keystore
                "let me in".toCharArray(),  // The keystore password
                "topSekritKey",  // The alias to be used (in external keystore)
                null,  // The key password or null if the key has none
                "test-alias" // The alias for the imported key
            )
        }


        // Set the TLS Identity
        URLEndpointListenerConfigurationFactory.create(
            database,
            identity = TLSIdentity.getIdentity("test-alias")
        ) <i class="conum" data-value="6"></i><b>(6)</b>

    }

    fun ibListenerConfigClientAuthRoot() {
        // Configure the client authenticator
        // to validate using ROOT CA
        // thisClientID.certs is a list containing a client cert to accept
        // and any other certs needed to complete a chain between the client cert
        // and a CA
        val validId = TLSIdentity.getIdentity("Our Corporate Id")
            ?: throw IllegalStateException("Cannot find corporate id")
        // accept only clients signed by the corp cert
        thisListener = URLEndpointListener(
            URLEndpointListenerConfigurationFactory.create(
                // get the identity <i class="conum" data-value="7"></i><b>(7)</b>
                database = database,
                identity = validId,
                authenticator = ListenerCertificateAuthenticator(validId.certs)
            )
        ) <i class="conum" data-value="8"></i><b>(8)</b>

    }

    fun ibListenerConfigTlsDisable2() {

        URLEndpointListenerConfigurationFactory.create(database = database, disableTls = true)
    }

    fun ibListenerStatusCheck() {
        val listener = URLEndpointListener(URLEndpointListenerConfigurationFactory.create(database = database))
        val connectionCount = listener.status?.connectionCount <i class="conum" data-value="9"></i><b>(9)</b>
        val activeConnectionCount = listener.status?.activeConnectionCount <i class="conum" data-value="10"></i><b>(10)</b>
    }

    fun ibListenerStop() {

        thisListener?.stop()

    }

    // ACTIVE PEER STUFF
// Replication code
    @Throws(CouchbaseLiteException::class, URISyntaxException::class)
    fun testActPeerSync() {
        // Create replicator
        // Consider holding a reference somewhere
        // to prevent the Replicator from being GCed
        val repl = Replicator( <i class="conum" data-value="11"></i><b>(11)</b>

            // initialize the replicator configuration
            ReplicatorConfigurationFactory.create(
                database = database,
                target = URLEndpoint(URI("wss://listener.com:8954")), <i class="conum" data-value="12"></i><b>(12)</b>

                // Set replicator type
                type = ReplicatorType.PUSH_AND_PULL,

                // Configure Sync Mode
                continuous = false, // default value


                // set auto-purge behavior
                // (here we override default)
                enableAutoPurge = false, <i class="conum" data-value="13"></i><b>(13)</b>



                // Configure Server Authentication --
                // only accept self-signed certs
                acceptOnlySelfSignedServerCertificate = true, <i class="conum" data-value="14"></i><b>(14)</b>

                // Configure the credentials the
                // client will provide if prompted
                authenticator = BasicAuthenticator("Our Username", "Our PasswordValue".toCharArray()), <i class="conum" data-value="15"></i><b>(15)</b>


                /* Optionally set custom conflict resolver call back <strong>/
                conflictResolver = null <i class="conum" data-value="16"></i><b>(16)</b>
            )
        )


        // Optionally add a change listener <i class="conum" data-value="17"></i><b>(17)</b>
        val thisListener = repl.addChangeListener { change -&gt;
            val err: CouchbaseLiteException? = change.status.error
            if (err != null) {
                Log.i(TAG, "Error code ::  ${err.code}", err)
            }
        }

        // Start replicator
        repl.start(false) <i class="conum" data-value="18"></i><b>(18)</b>
        thisReplicator = repl

    }

    fun ibReplicatorConfig() {
        // BEGIN additional snippets

        val repl = Replicator(
            ReplicatorConfigurationFactory.create(
                database = database,

                // Configure Server Security
                // -- only accept CA attested certs
                acceptOnlySelfSignedServerCertificate = false, <i class="conum" data-value="19"></i><b>(19)</b>




                // Use the pinned certificate from the byte array (cert)
                pinnedServerCertificate = caCert.encoded, <i class="conum" data-value="20"></i><b>(20)</b>


                // ... other replicator configuration
                // Provide a client certificate to the server for authentication
                authenticator = ClientCertificateAuthenticator(
                    TLSIdentity.getIdentity("clientId")
                        ?: throw IllegalStateException("Cannot find client id")
                ) <i class="conum" data-value="21"></i><b>(21)</b>

                // ... other replicator configuration

            )
        )

        thisReplicator = repl
    }

    fun ibP2pReplicatorStatus() {
        thisReplicator?.status?.let {
            Log.i(TAG, "The Replicator is currently ${it.activityLevel}")
            Log.i(TAG, "The Replicator has processed ${it.progress}")
            Log.i(
                TAG,
                if (it.activityLevel === ReplicatorActivityLevel.BUSY) {
                    "Replication Processing"
                } else {
                    "It has completed ${it.progress.total} changes"
                }
            )
        }
    }

    fun ibP2pReplicatorStop() {
        // Stop replication.
        thisReplicator?.stop() <i class="conum" data-value="22"></i><b>(22)</b>
    }

    fun ibP2pListener() {
        CouchbaseLite.init(context)
        val thisDB = Database("passivepeerdb") <i class="conum" data-value="23"></i><b>(23)</b>


        // Initialize the listener
        val listener = URLEndpointListener( <i class="conum" data-value="24"></i><b>(24)</b>

            // Initialize the listener config
            URLEndpointListenerConfigurationFactory.create(
                database = thisDB,
                port = 55990, /</strong> &lt;.&gt;  Optional; defaults to auto <strong>/
                disableTls = false, /</strong> &lt;.&gt;  Optional; defaults to false <strong>/
                enableDeltaSync = true,  /</strong> &lt;.&gt; Optional; defaults to false <strong>/

                // Configure the client authenticator (if using basic auth)
                authenticator = ListenerPasswordAuthenticator { username, password -&gt;
                    ("username" === username) &amp;&amp; (password === "password".toCharArray())  <i class="conum" data-value="25"></i><b>(25)</b>
                }
            )
        )

        // Start the listener
        listener.start() <i class="conum" data-value="26"></i><b>(26)</b>



//        Map&lt;String, String&gt; X509_ATTRIBUTES = mapOf(
//                TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME to "Couchbase Demo",
//                TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION to "Couchbase",
//                TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT to "Mobile",
//                TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS to "<a href="mailto:noreply@couchbase.com">noreply@couchbase.com</a>"
//        );
        val thisIdentity = TLSIdentity.createIdentity(
            true,
            mapOf(
                TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME to "Couchbase Demo",
                TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION to "Couchbase",
                TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT to "Mobile",
                TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS to "<a href="mailto:noreply@couchbase.com">noreply@couchbase.com</a>"
            ),
            null,
            "test-alias"
        )




        val thisAlias = "alias-to-delete"
        val thisKeyStore = KeyStore.getInstance("AndroidKeyStore")
        thisKeyStore.load(null)
        thisKeyStore.deleteEntry(thisAlias)


        // OPTIONALLY:: Retrieve a stored TLS identity using its alias/label
        val thatIdentity = TLSIdentity.getIdentity("couchbase-docs-cert")
    }

    fun ibRplicatorPull() {
        val database = Database("ian")

        val uri = URI("wss://10.0.2.2:4984/db") <i class="conum" data-value="27"></i><b>(27)</b>

        val repl = Replicator( <i class="conum" data-value="28"></i><b>(28)</b>
            ReplicatorConfigurationFactory.create(
                database = database,
                target = URLEndpoint(uri),
                type = ReplicatorType.PULL
            )
        )

        repl.start()
        thisReplicator = repl
    }

// initialize the replicator configuration
    val thisConfig = ReplicatorConfigurationFactory.create(
        database = database,
        target = URLEndpoint(URI("wss://10.0.2.2:8954/travel-sample"))

/</strong> C A L L O U T S

// Listener Callouts


&lt;.&gt; Initialize the listener instance using the configuration settings.
&lt;.&gt; Start the listener, ready to accept connections and incoming data from active peers.



&lt;.&gt; <code>connectionCount</code> -- the total number of connections served by the listener
&lt;.&gt; <code>activeConnectionCount</code> -- the number of active (BUSY) connections currently being served by the listener
//



&lt;.&gt; Configure the pinned certificate using data from the byte array <code>cert</code>

&lt;.&gt; Attempt to get the identity from secure storage
&lt;.&gt; Set the authenticator to ClientCertificateAuthenticator and configure it to use the retrieved identity


&lt;.&gt; A replication is an asynchronous operation.
To keep a reference to the <code>replicator</code> object, you can set it as an instance property.
&lt;.&gt; The URL scheme for remote database URLs uses <code>ws:</code>, or <code>wss:</code> for SSL/TLS connections over wb sockets.
In this example the hostname is <code>10.0.2.2</code> because the Android emulator runs in a VM that is generally accessible on <code>10.0.2.2</code> from the host machine (see <a href="https://developer.android.com/studio/run/emulator-networking">Android Emulator networking</a> documentation).
+
NOTE: As of Android Pie, version 9, API 28, cleartext support is disabled, by default.
Although <code>wss:</code> protocol URLs are not affected, in order to use the <code>ws:</code> protocol, applications must target API 27 or lower, or must configure application network security as described <a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted">here</a>.

<strong>/
}



// MODULE_END --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/IBExamples.kt 



// MODULE_BEGIN --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/ListenerExamples.kt 
//
// Copyright (c) 2021 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// <a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a>
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
package com.couchbase.code_snippets

import android.content.Context
import android.util.Log
import com.couchbase.lite.BasicAuthenticator
import com.couchbase.lite.ClientCertificateAuthenticator
import com.couchbase.lite.CouchbaseLiteException
import com.couchbase.lite.Database
import com.couchbase.lite.ListenerCertificateAuthenticator
import com.couchbase.lite.ListenerPasswordAuthenticator
import com.couchbase.lite.MutableDocument
import com.couchbase.lite.Replicator
import com.couchbase.lite.ReplicatorActivityLevel
import com.couchbase.lite.ReplicatorConfiguration
import com.couchbase.lite.ReplicatorConfigurationFactory
import com.couchbase.lite.ReplicatorType
import com.couchbase.lite.TLSIdentity
import com.couchbase.lite.URLEndpoint
import com.couchbase.lite.URLEndpointListener
import com.couchbase.lite.URLEndpointListenerConfigurationFactory
import com.couchbase.lite.create
import java.io.ByteArrayOutputStream
import java.io.IOException
import java.net.URI
import java.security.KeyStore
import java.security.KeyStoreException
import java.security.NoSuchAlgorithmException
import java.security.cert.Certificate
import java.security.cert.CertificateEncodingException
import java.security.cert.CertificateException
import java.util.concurrent.CountDownLatch

private const val TAG = "LISTEN"

@Suppress("unused")
class KtCertAuthListener {
    companion object {
        private val CERT_ATTRIBUTES = mapOf(
            TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME to "CBL Test",
            TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION to "Couchbase",
            TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT to "Mobile",
            TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS to "<a href="mailto:lite@couchbase.com">lite@couchbase.com</a>",
        )
    }

    // start a server and connect to it with a replicator
    @Throws(CouchbaseLiteException::class, IOException::class)
    fun run() {
        val localDb = Database("localDb")
        var doc = MutableDocument()
        doc.setString("dog", "woof")
        localDb.save(doc)

        val remoteDb = Database("remoteDb")
        doc = MutableDocument()
        doc.setString("cat", "meow")
        remoteDb.save(doc)

        val serverIdentity = TLSIdentity.createIdentity(true, CERT_ATTRIBUTES, null, "server")

        val clientIdentity = TLSIdentity.createIdentity(false, CERT_ATTRIBUTES, null, "client")
        val uri = startServer(remoteDb, serverIdentity, clientIdentity.certs)
            ?: throw IOException("Failed to start the server")

        Thread {
            startClient(localDb, uri, clientIdentity, serverIdentity.certs[0])
            Log.e(TAG, "Success!!")
            deleteIdentity("server")
            Log.e(TAG, "Alias deleted: server")
            deleteIdentity("client")
            Log.e(TAG, "Alias deleted: client")
        }.start()
    }

    // start a client replicator
    @Throws(CertificateEncodingException::class, InterruptedException::class)
    fun startClient(db: Database, uri: URI, clientIdentity: TLSIdentity, cert: Certificate) {
        val repl = Replicator(
            ReplicatorConfigurationFactory.create(
                database = db,
                target = URLEndpoint(uri),
                type = ReplicatorType.PUSH_AND_PULL,
                continuous = false,
                authenticator = ClientCertificateAuthenticator(clientIdentity),
                pinnedServerCertificate = cert.encoded
            )
        )

        val completionLatch = CountDownLatch(1)

        repl.addChangeListener { change -&gt;
            if (change.status.activityLevel == ReplicatorActivityLevel.STOPPED) {
                completionLatch.countDown()
            }
        }
        repl.start(false)
        completionLatch.await()
    }
    /<strong>
     * Snippet 2: create a ListenerCertificateAuthenticator and configure the listener with it
     *
     *
     * Start a listener for db that accepts connections from a client identified by any of the passed certs
     *
     * @param db    the database to which the listener is attached
     * @param certs the name of the single valid user
     * @return the url at which the listener can be reached.
     * @throws CouchbaseLiteException on failure
     */
    @Throws(CouchbaseLiteException::class)
    fun startServer(db: Database, serverId: TLSIdentity, certs: List&lt;Certificate?&gt;): URI? {
        val listener = URLEndpointListener(
            URLEndpointListenerConfigurationFactory.create(
                database = db,
                port = 0, // this is the default
                disableTls = false,
                identity = serverId,
                authenticator = ListenerCertificateAuthenticator(certs)
            )
        )
        listener.start()
        val urls: List&lt;URI&gt; = listener.urls
        return if (urls.isEmpty()) {
            null
        } else {
            urls[0]
        }
    }
    /</strong>
     * Delete an identity from the keystore
     *
     * @param alias the alias for the identity to be deleted
     */
    @Throws(
        KeyStoreException::class,
        CertificateException::class,
        NoSuchAlgorithmException::class,
        IOException::class
    )
    fun deleteIdentity(alias: String?) {
        val keyStore: KeyStore = KeyStore.getInstance("AndroidKeyStore")
        keyStore.load(null)
        keyStore.deleteEntry(alias) <i class="conum" data-value="29"></i><b>(29)</b>
    }
    // nottag::p2p-tlsid-tlsidentity-with-label[]
    /<strong>
     * Snippet 4: Create a ClientCertificateAuthenticator and use it in a replicator
     * Snippet 5: Specify a pinned certificate as a byte array
     *
     *
     * Configure Client (active) side certificates
     *
     * @param config         The replicator configuration
     * @param cert           The expected server side certificate
     * @param clientIdentity the identity offered to the server as authentication
     * @throws CertificateEncodingException on certifcate encoding error
     */
    @Throws(CertificateEncodingException::class)
    private fun configureClientCerts(
        config: ReplicatorConfiguration,
        cert: Certificate,
        clientIdentity: TLSIdentity
    ) {

        // Snippet 4: create an authenticator that provides the client identity
        config.setAuthenticator(ClientCertificateAuthenticator(clientIdentity))

        // Configure the pinned certificate passing a byte array.
        config.pinnedServerCertificate = cert.encoded
    }
    // notend::p2p-tlsid-tlsidentity-with-label[]
    /</strong>
     * Snippet 5 (supplement): Copy a cert from a resource bundle
     *
     *
     * Configure Client (active) side certificates
     *
     * @param context Android context
     * @param resId   resource id for resource: R.id.foo
     * @throws IOException on copy error
     */
    @Throws(IOException::class)
    private fun readCertMaterialFromBundle(
        context: Context,
        resId: Int
    ): ByteArray {
        val out = ByteArrayOutputStream()
        val <code>in</code> = context.resources.openRawResource(resId)
        val buf = ByteArray(1024)
        var n: Int
        while (<code>in</code>.read(buf).also { n = it } &gt;= 0) {
            out.write(buf, 0, n)
        }
        return out.toByteArray()
    }
}

@Suppress("unused")
class KtPasswordAuthListener {
    companion object {
        private const val VALID_USER = "Minnie"
        private val VALID_PASSWORD = "let me in!".toCharArray()
    }

    // start a server and connect to it with a replicator
    @Throws(CouchbaseLiteException::class, IOException::class)
    fun run() {
        val localDb = Database("localDb")
        var doc = MutableDocument()
        doc.setString("dog", "woof")
        localDb.save(doc)
        val remoteDb = Database("remoteDb")
        doc = MutableDocument()
        doc.setString("cat", "meow")
        localDb.save(doc)
        val uri = startServer(remoteDb, "fox", "wa-pa-pa-pa-pa-pow".toCharArray())
            ?: throw IOException("Failed to start the server")
        Thread {
            try {
                runClient(uri, "fox", "wa-pa-pa-pa-pa-pow".toCharArray(), localDb)
                Log.e(TAG, "Success!!")
            } catch (e: Exception) {
                Log.e(TAG, "Failed!!", e)
            }
        }.start()
    }

    // start a client replicator
    @Throws(InterruptedException::class)
    fun runClient(
        uri: URI,
        username: String,
        password: CharArray,
        db: Database
    ) {
        val config = ReplicatorConfiguration(db, URLEndpoint(uri))
        config.type = ReplicatorType.PUSH_AND_PULL
        config.isContinuous = false
        config.setAuthenticator(BasicAuthenticator(username, password))
        val completionLatch = CountDownLatch(1)
        val repl = Replicator(config)

        repl.addChangeListener { change -&gt;
            if (change.status
                    .activityLevel == ReplicatorActivityLevel.STOPPED
            ) {
                completionLatch.countDown()
            }
        }
        repl.start(false)
        completionLatch.await()
    }
    /</strong>*
     *
     * Start a listener for db that accepts connections using exactly the passed username and password
     *
     *
     * @param db       the database to which the listener is attached
     * @param username the name of the single valid user
     * @param password the password for the user
     * @return the url at which the listener can be reached.
     * @throws CouchbaseLiteException on failure
     <strong>/
    fun startServer(db: Database, username: String, password: CharArray): URI? {
        val listener = URLEndpointListener(
            URLEndpointListenerConfigurationFactory.create(
                database = db,
                port = 0,// this is the default
                disableTls = true,
                authenticator = ListenerPasswordAuthenticator { usr, pwd -&gt;
                    (usr == username) &amp;&amp; pwd.contentEquals(password)
                })
        )

        listener.start()
        val urls: List&lt;URI&gt; = listener.urls
        return if (urls.isEmpty()) {
            null
        } else {
            urls[0]
        }
    }
}





// MODULE_END --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/ListenerExamples.kt 



// MODULE_BEGIN --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/Peer2PeerExamples.kt 
//
// Copyright (c) 2021 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// <a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a>
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
package com.couchbase.code_snippets

import com.couchbase.lite.CouchbaseLiteException
import com.couchbase.lite.Database
import com.couchbase.lite.Message
import com.couchbase.lite.MessageEndpoint
import com.couchbase.lite.MessageEndpointConnection
import com.couchbase.lite.MessageEndpointDelegate
import com.couchbase.lite.MessageEndpointListener
import com.couchbase.lite.MessageEndpointListenerConfigurationFactory
import com.couchbase.lite.MessagingCloseCompletion
import com.couchbase.lite.MessagingCompletion
import com.couchbase.lite.ProtocolType
import com.couchbase.lite.Replicator
import com.couchbase.lite.ReplicatorConfigurationFactory
import com.couchbase.lite.ReplicatorConnection
import com.couchbase.lite.create


@Suppress("unused")
class BrowserSessionManager : MessageEndpointDelegate {
    private var replicator: Replicator? = null

    @Throws(CouchbaseLiteException::class)
    fun initCouchbase() {
        val database = Database("mydb")

        // The delegate must implement the <code>MessageEndpointDelegate</code> protocol.
        val messageEndpoint = MessageEndpoint("UID:123", "active", ProtocolType.MESSAGE_STREAM, this)

        // Create the replicator object.
        val repl = Replicator(ReplicatorConfigurationFactory.create(database = database, target = messageEndpoint))
        // Start the replication.
        repl.start()
        replicator = repl
    }

    /</strong> implementation of MessageEndpointDelegate <strong>/
    override fun createConnection(endpoint: MessageEndpoint) = ActivePeerConnection()
}

/</strong> ----------------------------------------------------------- <strong>/
/</strong> ---------------------  ACTIVE SIDE  ----------------------- <strong>/
/</strong> ----------------------------------------------------------- <strong>/

@Suppress("unused")
class ActivePeerConnection : MessageEndpointConnection {
    private var replicatorConnection: ReplicatorConnection? = null

    fun disconnect() {
        replicatorConnection?.close(null)
        replicatorConnection = null
    }

    /</strong> implementation of MessageEndpointConnection <strong>/
    override fun open(connection: ReplicatorConnection, completion: MessagingCompletion) {
        replicatorConnection = connection
        completion.complete(true, null)
    }

    override fun close(error: Exception?, completion: MessagingCloseCompletion) {
        /</strong> disconnect with communications framework <strong>/
        /</strong> ... <strong>/
        /</strong> call completion handler <strong>/
        completion.complete()
    }

    /</strong> implementation of MessageEndpointConnection <strong>/
    override fun send(message: Message, completion: MessagingCompletion) {
        /</strong> send the data to the other peer <strong>/
        /</strong> ... <strong>/
        /</strong> call the completion handler once the message is sent <strong>/
        completion.complete(true, null)
    }

    fun receive(message: Message) {
        replicatorConnection?.receive(message)
    }
}

/</strong> ----------------------------------------------------------- <strong>/
/</strong> ---------------------  PASSIVE SIDE  ---------------------- <strong>/
/</strong> ----------------------------------------------------------- <strong>/

@Suppress("unused")
class PassivePeerConnection private constructor() : MessageEndpointConnection {
    private var messageEndpointListener: MessageEndpointListener? = null
    private var replicatorConnection: ReplicatorConnection? = null

    @Throws(CouchbaseLiteException::class)
    fun startListener() {
        val database = Database("mydb")
        messageEndpointListener = MessageEndpointListener(
            MessageEndpointListenerConfigurationFactory.create(database, ProtocolType.MESSAGE_STREAM)
        )
    }

    fun stopListener() {
        messageEndpointListener?.closeAll()
    }

    fun accept() {
        val connection = PassivePeerConnection() /</strong> implements MessageEndpointConnection <strong>/
        messageEndpointListener?.accept(connection)
    }

    fun disconnect() {
        replicatorConnection?.close(null)
    }

    /</strong> implementation of MessageEndpointConnection <strong>/
    override fun open(connection: ReplicatorConnection, completion: MessagingCompletion) {
        replicatorConnection = connection
        completion.complete(true, null)
    }

    /</strong> implementation of MessageEndpointConnection <strong>/
    override fun close(error: Exception?, completion: MessagingCloseCompletion) {
        /</strong> disconnect with communications framework <strong>/
        /</strong> ... <strong>/
        /</strong> call completion handler <strong>/
        completion.complete()
    }

    /</strong> implementation of MessageEndpointConnection <strong>/
    override fun send(message: Message, completion: MessagingCompletion) {
        /</strong> send the data to the other peer <strong>/
        /</strong> ... <strong>/
        /</strong> call the completion handler once the message is sent <strong>/
        completion.complete(true, null)
    }

    fun receive(message: Message) {
        replicatorConnection?.receive(message)
    }

}



// MODULE_END --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/Peer2PeerExamples.kt 



// MODULE_BEGIN --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/QueryExamples.kt 
//
// Copyright (c) 2021 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// <a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a>
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
package com.couchbase.code_snippets

import android.util.Log
import com.couchbase.lite.</strong>
import com.couchbase.lite.Function
import com.fasterxml.jackson.databind.ObjectMapper
import org.json.JSONException


private const val TAG = "QUERY"
private const val DATABASE_NAME = "database"

data class Hotel(
    var description: String? = null,
    var country: String? = null,
    var city: String? = null,
    var name: String? = null,
    var type: String? = null,
    var id: String? = null
)

@Suppress("unused")
class QueryExamples(private val database: Database) {

    // <mark># Indexing
    @Throws(CouchbaseLiteException::class)
    fun testIndexing() {
        database.createIndex(
          "TypeNameIndex",
          ValueIndexConfigurationFactory.create("type","name")
        )

    }

    fun testIndexing_Querybuilder() {
        database.createIndex(
            "TypeNameIndex",
            IndexBuilder.valueIndex(
                ValueIndexItem.property("type"),
                ValueIndexItem.property("name")
            )
        )
    }

    // </mark># SELECT statement
    fun testSelectStatement() {
        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("name"),
                SelectResult.property("type")
            )
            .from(DataSource.database(database))
            .where(Expression.property("type").equalTo(Expression.string("hotel")))
            .orderBy(Ordering.expression(Meta.id))
            .execute()

        for (result in rs) {
            Log.i(TAG, "hotel id -&gt;${result.getString("id")}")
            Log.i(TAG, "hotel name -&gt; ${result.getString("name")}")
        }
      }

      // META function
      @Throws(CouchbaseLiteException::class)
      fun testMetaFunction() {
        val rs = QueryBuilder
        .select(SelectResult.expression(Meta.id))
        .from(DataSource.database(database))
        .where(Expression.property("type").equalTo(Expression.string("airport")))
        .orderBy(Ordering.expression(Meta.id))
        .execute()

        for (result in rs) {
          Log.w(TAG, "airport id -&gt;${result.getString("id")}")
          Log.w(TAG, "airport id -&gt; ${result.getString(0)}")
        }
      }

      // <mark># all(<strong>)
    @Throws(CouchbaseLiteException::class)
    fun testSelectAll() {
        val queryAll = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(Expression.property("type").equalTo(Expression.string("hotel")))

        val query = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database)) <i class="conum" data-value="30"></i><b>(30)</b>

        // Adds a query change listener.
        // Changes will be posted on the main queue.
        val token = query.addChangeListener { change -&gt;
            change.results?.let {
                for (result in it) {
                    Log.d(TAG, "results: ${result.keys}")
                    /</strong> Update UI <strong>/
                }
            } <i class="conum" data-value="31"></i><b>(31)</b>
        }


        query.removeChangeListener(token)

        for (result in query.execute()) {
            Log.i(TAG, "hotel -&gt; ${result.getDictionary(DATABASE_NAME)?.toMap()}")
        }
    }


    // </mark>#　WHERE statement
    @Throws(CouchbaseLiteException::class)
    fun testWhereStatement() {
        val rs = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(Expression.property("type").equalTo(Expression.string("hotel")))
            .limit(Expression.intValue(10))
            .execute()
        for (result in rs) {
            result.getDictionary(DATABASE_NAME)?.let {
                Log.i(TAG, "name -&gt; ${it.getString("name")}")
                Log.i(TAG, "type -&gt; ${it.getString("type")}")
            }
        }
    }

    fun testQueryDeletedDocuments() {
        // Query documents that have been deleted
        val query = QueryBuilder
            .select(SelectResult.expression(Meta.id))
            .from(DataSource.database(database))
            .where(Meta.deleted)
    }

    // <mark><mark>#　Collection Operators
    @Throws(CouchbaseLiteException::class)
    fun testCollectionStatement() {
        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("name"),
                SelectResult.property("public_likes")
            )
            .from(DataSource.database(database))
            .where(
                Expression.property("type").equalTo(Expression.string("hotel"))
                    .and(
                        ArrayFunction.contains(
                            Expression.property("public_likes"),
                            Expression.string("Armani Langworth")
                        )
                    )
            )
            .execute()
        for (result in rs) {
            Log.i(TAG, "public_likes -&gt; ${result.getArray("public_likes")?.toList()}")
        }
    }

    // IN operator
    @Throws(CouchbaseLiteException::class)
    fun testInOperator() {
        val rs = QueryBuilder.select(SelectResult.all())
            .from(DataSource.database(database))
            .where(
                Expression.string("Armani").<code>in</code>(
                    Expression.property("first"),
                    Expression.property("last"),
                    Expression.property("username")
                )
            )
            .execute()

        for (result in rs) {
            Log.i(TAG, "public_likes -&gt; ${result.toMap()}")
        }
    }

    // Pattern Matching
    @Throws(CouchbaseLiteException::class)
    fun testPatternMatching() {
        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("country"),
                SelectResult.property("name")
            )
            .from(DataSource.database(database))
            .where(
                Expression.property("type").equalTo(Expression.string("landmark"))
                    .and(
                        Function.lower(Expression.property("name"))
                            .like(Expression.string("royal engineers museum"))
                    )
            )
            .execute()

        for (result in rs) {
            Log.i(TAG, "name -&gt; ${result.getString("name")}")
        }
    }

    // </mark></mark> Wildcard Match
    @Throws(CouchbaseLiteException::class)
    fun testWildcardMatch() {
        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("country"),
                SelectResult.property("name")
            )
            .from(DataSource.database(database))
            .where(
                Expression.property("type").equalTo(Expression.string("landmark"))
                    .and(
                        Function.lower(Expression.property("name"))
                            .like(Expression.string("eng%e%"))
                    )
            )
            .execute()

        for (result in rs) {
            Log.i(TAG, "name -&gt; ${result.getString("name")}")
        }
    }

    // Wildcard Character Match
    @Throws(CouchbaseLiteException::class)
    fun testWildCharacterMatch() {

        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("country"),
                SelectResult.property("name")
            )
            .from(DataSource.database(database))
            .where(
                Expression.property("type").equalTo(Expression.string("landmark"))
                    .and(
                        Function.lower(Expression.property("name"))
                            .like(Expression.string("eng____r"))
                    )
            )
            .execute()

        for (result in rs) {
            Log.i(TAG, "name -&gt; ${result.getString("name")}")
        }
    }

    // <mark># Regex Match
    @Throws(CouchbaseLiteException::class)
    fun testRegexMatch() {
        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("country"),
                SelectResult.property("name")
            )
            .from(DataSource.database(database))
            .where(
                Expression.property("type").equalTo(Expression.string("landmark"))
                    .and(
                        Function.lower(Expression.property("name"))
                            .regex(Expression.string("\\beng.*r\\b"))
                    )
            )
            .execute()
        for (result in rs) {
            Log.i(TAG, "name -&gt; ${result.getString("name")}")
        }
    }

    // JOIN statement
    @Throws(CouchbaseLiteException::class)
    fun testJoinStatement() {
        val rs = QueryBuilder.select(
            SelectResult.expression(Expression.property("name").from("airline")),
            SelectResult.expression(Expression.property("callsign").from("airline")),
            SelectResult.expression(Expression.property("destinationairport").from("route")),
            SelectResult.expression(Expression.property("stops").from("route")),
            SelectResult.expression(Expression.property("airline").from("route"))
        )
            .from(DataSource.database(database).as("airline"))
            .join(
                Join.join(DataSource.database(database).as("route"))
                    .on(
                        Meta.id.from("airline")
                            .equalTo(Expression.property("airlineid").from("route"))
                    )
            )
            .where(
                Expression.property("type").from("route").equalTo(Expression.string("route"))
                    .and(
                        Expression.property("type").from("airline")
                            .equalTo(Expression.string("airline"))
                    )
                    .and(
                        Expression.property("sourceairport").from("route")
                            .equalTo(Expression.string("RIX"))
                    )
            )
            .execute()

        for (result in rs) {
            Log.i(TAG, "name -&gt; ${result.toMap()}")
        }
    }


    // </mark># GROUPBY statement
    @Throws(CouchbaseLiteException::class)
    fun testGroupByStatement() {
        val rs = QueryBuilder.select(
            SelectResult.expression(Function.count(Expression.string("</strong>"))),
            SelectResult.property("country"),
            SelectResult.property("tz")
        )
            .from(DataSource.database(database))
            .where(
                Expression.property("type").equalTo(Expression.string("airport"))
                    .and(Expression.property("geo.alt").greaterThanOrEqualTo(Expression.intValue(300)))
            )
            .groupBy(
                Expression.property("country"), Expression.property("tz")
            )
            .orderBy(Ordering.expression(Function.count(Expression.string("<strong>"))).descending())
            .execute()

        for (result in rs) {
            result.let {
                Log.i(
                    TAG,
                    "There are ${it.getInt("$1")} airports on the ${
                        it.getString("tz")
                    } timezone located in ${
                        it.getString("country")
                    } and above 300ft"
                )
            }
        }
    }

    // <mark># ORDER BY statement
    @Throws(CouchbaseLiteException::class)
    fun testOrderByStatement() {
        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("name")
            )
            .from(DataSource.database(database))
            .where(Expression.property("type").equalTo(Expression.string("hotel")))
            .orderBy(Ordering.property("name").ascending())
            .limit(Expression.intValue(10))
            .execute()

        for (result in rs) {
            Log.i(TAG, "${result.toMap()}")
        }
    }


    // </mark># EXPLAIN statement
    @Throws(CouchbaseLiteException::class)
    fun testExplainStatement() {
        var query: Query = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(Expression.property("type").equalTo(Expression.string("university")))
            .groupBy(Expression.property("country"))
            .orderBy(Ordering.property("name").descending()) <i class="conum" data-value="32"></i><b>(32)</b>
        Log.i(TAG, query.explain()) <i class="conum" data-value="33"></i><b>(33)</b>

        query = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(Expression.property("type").like(Expression.string("%hotel%"))) <i class="conum" data-value="34"></i><b>(34)</b>
        Log.i(TAG, query.explain())

        query = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(
                Expression.property("type").like(Expression.string("hotel%")) <i class="conum" data-value="35"></i><b>(35)</b>
                    .and(Expression.property("name").like(Expression.string("%royal%")))
            )
        Log.i(TAG, query.explain())

        query = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(
                Function.lower(
                    Expression.property("type").equalTo(Expression.string("hotel"))
                )
            ) <i class="conum" data-value="36"></i><b>(36)</b>
        Log.i(TAG, query.explain())

        query = QueryBuilder
            .select(SelectResult.all())
            .from(DataSource.database(database))
            .where(Expression.property("type").equalTo(Expression.string("hotel"))) <i class="conum" data-value="37"></i><b>(37)</b>
        Log.i(TAG, query.explain())
    }

    @Throws(CouchbaseLiteException::class)
    fun prepareIndex() {

      database.createIndex("overviewFTSIndex",
                      FullTextIndexConfigurationFactory.create(
                        expressions = ["overview"]
                      )
                    )

    }

    @Throws(CouchbaseLiteException::class)
    fun testFTS() {

        val ftsQuery =
              database.createQuery(
                "SELECT _id, overview FROM _ WHERE MATCH(overviewFTSIndex, 'michigan') ORDER BY RANK(overviewFTSIndex)")

        ftsQuery.execute().allResults().forEach {
          Log.i(TAG, "${result.getString("id")}: ${result.getString("overview")}")
        }

    }

    @Throws(CouchbaseLiteException::class)
    fun prepareIndex_Querybuilder() {
        database.createIndex(
            "overviewFTSIndex",
            IndexBuilder.fullTextIndex(FullTextIndexItem.property("overview")).ignoreAccents(false)
        )
    }

    @Throws(CouchbaseLiteException::class)
    fun testFTS_Querybuilder() {

        val ftsQuery =
              QueryBuilder.select(SelectResult.expression(Meta.id),
                                  SelectResult.expression(overview))
                          .from(DataSource.database(database))
                          .where(FullTextFunction.match("overviewFTSIndex", "michigan"))
                          .execute()

        ftsQuery.execute().allResults().forEach {
          Log.i(TAG, "${result.getString("Meta.id")}: ${result.getString("overview")}")
          }



    }


    fun testQuerySyntaxAll(currentUser: String) {
        val listQuery: Query = QueryBuilder.select(SelectResult.all())
            .from(DataSource.database(openOrCreateDatabaseForUser(currentUser)))

        val hotels: HashMap&lt;String, Hotel&gt; = HashMap()

        for (result in listQuery.execute().allResults()) {
            // get the k-v pairs from the 'hotel' key's value into a dictionary
            val thisDocsProps = result.getDictionary(0) <i class="conum" data-value="38"></i><b>(38)</b>
            val thisDocsId = thisDocsProps!!.getString("id")
            val thisDocsName = thisDocsProps.getString("name")
            val thisDocsType = thisDocsProps.getString("type")
            val thisDocsCity = thisDocsProps.getString("city")

            // Alternatively, access results value dictionary directly
            val id = result.getDictionary(0)?.getString("id").toString() <i class="conum" data-value="39"></i><b>(39)</b>
            hotels[id] = Hotel(
                id,
                result.getDictionary(0)?.getString("type"),
                result.getDictionary(0)?.getString("name"),
                result.getDictionary(0)?.getString("city"),
                result.getDictionary(0)?.getString("country"),
                result.getDictionary(0)?.getString("description")
            )
        }

    }

    @Throws(CouchbaseLiteException::class, JSONException::class)
    fun testQuerySyntaxJson(currentUser: String, argDb: Database) {
        val db = argDb
        // Example assumes Hotel class object defined elsewhere

        // Build the query
        val listQuery: Query = QueryBuilder.select(SelectResult.all())
            .from(DataSource.database(db))

        // Uses Jackson JSON processor
        val mapper = ObjectMapper()
        val hotels: ArrayList&lt;Hotel&gt; = ArrayList()

        for (result in listQuery.execute()) {

            // Get result as JSON string
            val json = result.toJSON() <i class="conum" data-value="40"></i><b>(40)</b>

            // Get Hashmap from JSON string
            val dictFromJSONstring = mapper.readValue(json, HashMap::class.java) <i class="conum" data-value="41"></i><b>(41)</b>

            // Use created hashmap
            val hotelId = dictFromJSONstring["id"].toString() //
            val hotelType = dictFromJSONstring["type"].toString()
            val hotelname = dictFromJSONstring["name"].toString()


            // Get custom object from JSON string
            val thisHotel = mapper.readValue(json, Hotel::class.java) <i class="conum" data-value="42"></i><b>(42)</b>
            hotels.add(thisHotel)
        }
    }
/</strong> end func testQuerySyntaxJson <strong>/



    fun testQuerySyntaxProps(currentUser: String) {

        val rs = QueryBuilder
            .select(
                SelectResult.expression(Meta.id),
                SelectResult.property("country"),
                SelectResult.property("name")
            )
            .from(DataSource.database(database))


        for (result in rs.execute().allResults()) {
            Log.i(TAG, "Hotel name -&gt; ${result.getString("name")}, in ${result.getString("country")}" )
        }
    }

    fun testQuerySyntaxCount(currentUser: String) {

        val rs = QueryBuilder
            .select(
                SelectResult.expression(Function.count(Expression.string("</strong>"))).as("mycount")) <i class="conum" data-value="43"></i><b>(43)</b>
            .from(DataSource.database(database))


        for (result in rs.execute().allResults()) {
            Log.i(TAG, "name -&gt; ${result.getInt("mycount").toString()}")
        }
    }


    fun testQuerySyntaxId(currentUser: String) {
        // tag::query-select-meta

        val rs = QueryBuilder
        .select(
          SelectResult.expression(Meta.id).as("hotelId"))
          .from(DataSource.database(database))


        for (result in rs.execute().allResults()) {
          Log.i(TAG, "hotel id -&gt;${result.getString("hotelId")}")
        }
        // end::query-select-meta
    }


    fun docsOnlyQuerySyntaxN1QL(argDb: Database): List&lt;Result&gt; {
      // For Documentation -- N1QL Query using parameters
      val db = argDb
      val thisQuery = db.createQuery(
            "SELECT META().id AS id FROM _ WHERE type = \"hotel\"") <i class="conum" data-value="44"></i><b>(44)</b>

      return thisQuery.execute().allResults()

  }

  fun docsOnlyQuerySyntaxN1QLParams(argDb: Database): List&lt;Result&gt; {
      // For Documentation -- N1QL Query using parameters
      val db = argDb
      val thisQuery = db.createQuery(
            "SELECT META().id AS id FROM _ WHERE type = \$type") <i class="conum" data-value="45"></i><b>(45)</b>

      thisQuery.parameters = Parameters().setString("type", "hotel") <i class="conum" data-value="46"></i><b>(46)</b>

      return thisQuery.execute().allResults()

  }

  fun testQuerySyntaxPagination(currentUser: String) {
    val limit = 20
    val offset = 0

    val rs = QueryBuilder
      .select(SelectResult.all())
      .from(DataSource.database(database))
      .where(Expression.property("type").equalTo(Expression.string("hotel")))
      .limit(Expression.intValue(limit), Expression.intValue(offset))

  }

    fun openOrCreateDatabaseForUser(argUser: String): Database = Database(argUser) {

    }



// MODULE_END --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/QueryExamples.kt 



// MODULE_BEGIN --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/JSONExamples.kt 
//
// Copyright (c) 2021 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// <a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a>
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
package com.couchbase.code_snippets

import android.util.Log
import com.couchbase.lite.*
import org.json.JSONException
import org.json.JSONObject


const val JSON = """[{\"id\":\"1000\",\"type\":\"hotel\",\"name\":\"Hotel Ted\",\"city\":\"Paris\",
        \"country\":\"France\",\"description\":\"Undefined description for Hotel Ted\"},
        {\"id\":\"1001\",\"type\":\"hotel\",\"name\":\"Hotel Fred\",\"city\":\"London\",
        \"country\":\"England\",\"description\":\"Undefined description for Hotel Fred\"},
        {\"id\":\"1002\",\"type\":\"hotel\",\"name\":\"Hotel Ned\",\"city\":\"Balmain\",
        \"country\":\"Australia\",\"description\":\"Undefined description for Hotel Ned\",
        \"features\":[\"Cable TV\",\"Toaster\",\"Microwave\"]}]"""


class KtJSONExamples {
    private val TAG = "SNIPPETS"

    fun jsonArrayExample(db: Database) {
        // github tag=tojson-array
        val mArray = MutableArray(JSON) <i class="conum" data-value="47"></i><b>(47)</b>
        for (i in 0 until mArray.count()) {
            mArray.getDictionary(i)?.apply {
                Log.i(TAG, getString("name") ?: "unknown")
                db.save(MutableDocument(getString("id"), toMap()))
            } <i class="conum" data-value="48"></i><b>(48)</b>
        }

        db.getDocument("1002")?.getArray("features")?.apply {
            for (feature in toList()) {
                Log.i(TAG, "$feature")
            } <i class="conum" data-value="49"></i><b>(49)</b>
            Log.i(TAG, toJSON())
        } <i class="conum" data-value="50"></i><b>(50)</b>
    }

    fun jsonBlobExample(db: Database) {
        // github tag=tojson-blob
        val thisBlob = db.getDocument("thisdoc-id")!!.toMap()
        if (!Blob.isBlob(thisBlob)) {
          return
        }
        val blobType = thisBlob["content_type"].toString()
        val blobLength = thisBlob["length"] as Number?
    }

    fun jsonDictionaryExample() {
        // github tag=tojson-dictionary
        val mDict = MutableDictionary(JSON) <i class="conum" data-value="51"></i><b>(51)</b>
        Log.i(TAG, "$mDict")
        Log.i(TAG, "Details for: ${mDict.getString("name")}")
        for (key in mDict.keys) {
          Log.i(TAG, key + " =&gt; " + mDict.getValue(key))
        }
      }

      @Throws(CouchbaseLiteException::class)
      fun jsonDocumentExample(srcDb: Database, dstDb: Database) {
        QueryBuilder
        .select(SelectResult.expression(Meta.id).as("metaId"))
        .from(DataSource.database(srcDb))
        .execute()
        .forEach {
          it.getString("metaId")?.let { thisId -&gt;
            srcDb.getDocument(thisId)?.toJSON()?.let { json -&gt; <i class="conum" data-value="52"></i><b>(52)</b>
              Log.i(TAG, "JSON String = $json")
              val hotelFromJSON = MutableDocument(thisId, json) <i class="conum" data-value="53"></i><b>(53)</b>
              dstDb.save(hotelFromJSON)
              dstDb.getDocument(thisId)?.toMap()?.forEach { e -&gt;
                Log.i(TAG, "$e.key =&gt; $e.value")
              } <i class="conum" data-value="54"></i><b>(54)</b>
            }
          }
        }
    }

    @Throws(CouchbaseLiteException::class, JSONException::class)
    fun jsonQueryExample(query: Query) {
        query.execute().forEach {

            // Use a Json Object to populate Native object
            JSONObject(it.toJSON()).apply {
                val (description, country, city, name, type, id) = Hotel(
                    id = getString("id"),
                    type = getString("type"),
                    name = getString("name"),
                    city = getString("city"),
                    country = "Ghana, West Africa",
                    description = "this hotel"
                )
            }
        }
    }
}


// MODULE_END --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/JSONExamples.kt 



// MODULE_BEGIN --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/BlobExamples.kt 
//
// Copyright (c) 2021 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// <a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a>
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
package com.couchbase.code_snippets

import android.content.Context
import android.util.Log
import com.couchbase.lite.Blob
import com.couchbase.lite.Database
import com.couchbase.lite.MutableDictionary

class KtBlobExamples {

    // Example 2: Using Blobs
    fun example2(context: Context, db: Database) {
        val doc = db.getDocument("1000") ?: return

        // Create a blob from an asset
        val blob = Blob("image/png", context.assets.open("couchbaseimage.png"))

        // This will fail:
        // IllegalStateException("A Blob may be encoded as JSON only after it has been saved in a database")
        blob.toJSON()

        // Save the blob as part of a document
        db.save(doc.toMutable().setBlob("avatar", blob))

        // Experts only!!!
        db.saveBlob(blob)

        // Retrieve saved blob and get as JSON again
        val blobAsJSONString = db.getDocument("1000")?.getBlob("avatar")?.toJSON() ?: return

        // reconstitute
        val blobAsMap = MutableDictionary().setJSON(blobAsJSONString).toMap()

        // show the contents of the reconstituted blob
        for key, value) in blobAsMap) {             Log.d("BLOB", "Data: $key -&gt; $value")         }          // verify that the reconstitued thing is still blob         if (Blob.isBlob(blobAsMap {
            Log.d("BLOB", blobAsJSONString)
        }
    }
}


// MODULE_END --/Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/examples/snippets/app/src/main/kotlin/com/couchbase/code_snippets/BlobExamples.kt </code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset8_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">// Configure Client Security using an Authenticator
// For example, Basic Authentication <i class="conum" data-value="1"></i><b>(1)</b>
thisConfig.setAuthenticator(new ListenerPasswordAuthenticator(
  (validUser, validPassword) -&gt;
    username.equals(validUser) &amp;&amp;
    Arrays.equals(password, validPassword)));</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Where 'username'/'password' are the client-supplied values (from the http-authentication header) and <code>validUser</code>/<code>validPassword</code> are the values acceptable to the server.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-client-certificate-authentication"><a class="anchor" href="#using-client-certificate-authentication"></a>Using Client Certificate Authentication</h3>
<div class="paragraph">
<p>Define how the server will authenticate client-supplied certificates.</p>
</div>
<div class="paragraph">
<p>There are two ways to authenticate a client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A chain of one or more certificates that ends at a certificate in the list of certificates supplied to the constructor for  <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/ListenerCertificateAuthenticator.html">ListenerCertificateAuthenticator</a>&#8201;&#8212;&#8201;see: <a href="#ex-set-cert-auth">Example 9</a></p>
</li>
<li>
<p>Application logic: This method assumes complete responsibility for verifying and authenticating the client&#8201;&#8212;&#8201;see: <a href="#ex-use-app-logic">Example 10</a></p>
<div class="paragraph">
<p>If the parameter supplied to the constructor for <code>ListenerCertificateAuthenticator</code> is of type  <code>ListenerCertificateAuthenticatorDelegate</code>, all other forms of authentication are bypassed.</p>
</div>
<div class="paragraph">
<p>The client response to the certificate request is passed to the method supplied as the constructor parameter.
The logic should take the form of function or block (such as, a closure expression) where the platform allows.</p>
</div>
</li>
</ul>
</div>
<div id="ex-set-cert-auth" class="exampleblock">
<div class="title">Example 9. Set Certificate Authorization</div>
<div class="content">
<div class="paragraph">
<p>Configure the server (listener) to authenticate the client against a list of one or more certificates provided by the server to the the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/ListenerCertificateAuthenticator.html">ListenerCertificateAuthenticator</a>.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset9_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset9_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset9_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">// Configure the client authenticator
// to validate using ROOT CA
// thisClientID.certs is a list containing a client cert to accept
// and any other certs needed to complete a chain between the client cert
// and a CA
val validId = TLSIdentity.getIdentity("Our Corporate Id")
    ?: throw IllegalStateException("Cannot find corporate id")
// accept only clients signed by the corp cert
thisListener = URLEndpointListener(
    URLEndpointListenerConfigurationFactory.create(
        // get the identity <i class="conum" data-value="1"></i><b>(1)</b>
        database = database,
        identity = validId,
        authenticator = ListenerCertificateAuthenticator(validId.certs)
    )
) <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset9_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">// Configure the client authenticator
// to validate using ROOT CA
// thisClientID.certs is a list containing a client cert to accept
// and any other certs needed to complete a chain between the client cert
// and a CA
final TLSIdentity validId =
  TLSIdentity.getIdentity("Our Corporate Id");  // get the identity <i class="conum" data-value="1"></i><b>(1)</b>

if (validId == null) { throw new IllegalStateException("Cannot find corporate id"); }

thisConfig.setTlsIdentity(validId);

thisConfig.setAuthenticator(
  new ListenerCertificateAuthenticator(validId.getCerts())); <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
  // accept only clients signed by the corp cert

final URLEndpointListener thisListener =
  new URLEndpointListener(thisConfig);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the identity data to authenticate against.
This can be, for example, from a resource file provided with the app, or an identity previously saved in secure storage.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the authenticator to authenticate the client supplied certificate(s) using these root certs.
A valid client will provide one or more certificates that match a certificate in this list.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the authenticator to the listener configuration.</td>
</tr>
</table>
</div>
<div id="ex-use-app-logic" class="exampleblock">
<div class="title">Example 10. Application Logic</div>
<div class="content">
<div class="paragraph">
<p>Configure the server (listener) to authenticate the client using user-supplied logic.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset10_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset10_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset10_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin">[data-source-url=https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt]</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset10_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">// Configure authentication using application logic
  final TLSIdentity thisCorpId = TLSIdentity.getIdentity("OurCorp"); <i class="conum" data-value="1"></i><b>(1)</b>
  if (thisCorpId == null) {
    throw new IllegalStateException("Cannot find corporate id"); }
  thisConfig.setTlsIdentity(thisCorpId);
  thisConfig.setAuthenticator(
    new ListenerCertificateAuthenticator(
      (thisCorpId.getCerts()) -&gt; {
      // use supplied logic that resolves to boolean
      // true=valid, false=invalid
      }
    )); <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
  final ULEndpointListener thisListener =
    new URLEndpointListener(thisConfig);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the identity data to authenticate against.
This can be, for example, from a resource file provided with the app, or an identity previously saved in secure storage.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the Authenticator to pass the root certificates to a user supplied code block.
This code assumes complete responsibility for authenticating the client supplied certificate(s).
It must return a boolean value; with <code>true</code> denoting the client supplied certificate authentic.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the authenticator to the listener configuration.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="delete-tls-identity"><a class="anchor" href="#delete-tls-identity"></a>Delete Entry</h3>
<div class="paragraph">
<p>You can remove unwanted entries from secure storage using the secure storage API (see&#8201;&#8212;&#8201;<a href="https://developer.android.com/reference/java/security/KeyStore#deleteEntry(java.lang.String)" class="bare">https://developer.android.com/reference/java/security/KeyStore#deleteEntry(java.lang.String)</a>).</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Deleting TLS Identities</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset11_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset11_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset11_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">val thisAlias = "alias-to-delete"
val thisKeyStore = KeyStore.getInstance("AndroidKeyStore")
thisKeyStore.load(null)
thisKeyStore.deleteEntry(thisAlias)</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset11_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">String thisAlias = "alias-to-delete";
final KeyStore thisKeyStore
  =  KeyStore.getInstance("AndroidKeyStore");
thisKeyStore.load(null);
thisKeyStore.deleteEntry(thisAlias);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-impact-of-tls-settings"><a class="anchor" href="#the-impact-of-tls-settings"></a>The Impact of TLS Settings</h3>
<div class="paragraph">
<p>The table in this section shows the expected system behavior (in regards to security) depending on the TLS configuration settings deployed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Expected system behavior</caption>
<colgroup>
<col style="width: 12%;">
<col style="width: 44%;">
<col style="width: 44%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">disableTLS</th>
<th class="tableblock halign-left valign-top">tlsIdentity (corresponding to server)</th>
<th class="tableblock halign-left valign-top">Expected system behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignored</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TLS is disabled; all communication is plain text.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>set to nil</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>The system will auto generate an <em>anonymous</em> self signed cert.</p>
</li>
<li>
<p>Active peers (clients) should be configured to accept self-signed certificates.</p>
</li>
<li>
<p>Communication is encrypted</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set to server identity generated from a self- or CA-signed certificate</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On first use&#8201;&#8212;&#8201;Bring your own certificate and private key; for example, using the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/TLSIdentity.html">TLSIdentity</a> class&#8217;s <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/TLSIdentity.html#createIdentity-boolean-java.util.Map-java.util.Date-java.lang.String-">createIdentity()</a> method to add it to the secure storage.</p>
</li>
<li>
<p>Each time&#8201;&#8212;&#8201;Use the server identity from the certificate stored in the secure storage; for example, using the <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/TLSIdentity.html">TLSIdentity</a> class&#8217;s <a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/TLSIdentity.html#getIdentity-java.lang.String-">getIdentity()</a> method with the alias you want to retrieve..</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System will use the configured identity.</p>
</li>
<li>
<p>Active peers will validate the server certificate corresponding to the TLSIdentity (as long as they are configured to not skip validation&#8201;&#8212;&#8201;see <a href="#lbl-tls-security">TLS Security</a>).</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-start-listener"><a class="anchor" href="#lbl-start-listener"></a>Start Listener</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have completed the Listener&#8217;s configuration settings you can initialize the Listener instance and start it running&#8201;&#8212;&#8201;see: <a href="#initialize-and-start-listener">Example 12</a></p>
</div>
<div id="initialize-and-start-listener" class="exampleblock">
<div class="title">Example 12. Initialize and start listener</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset12_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset12_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset12_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">// Initialize the listener
val listener = URLEndpointListener(
    URLEndpointListenerConfigurationFactory.create(
        database = database, <i class="conum" data-value="1"></i><b>(1)</b>
        port = 55990, <i class="conum" data-value="2"></i><b>(2)</b>
        networkInterface = "10.1.1.10", <i class="conum" data-value="3"></i><b>(3)</b>

        enableDeltaSync = false, <i class="conum" data-value="4"></i><b>(4)</b>

        // Configure server security
        disableTls = false, <i class="conum" data-value="5"></i><b>(5)</b>

        // Use an Anonymous Self-Signed Cert
        identity = null, <i class="conum" data-value="6"></i><b>(6)</b>

        // Configure Client Security using an Authenticator
        // For example, Basic Authentication <i class="conum" data-value="7"></i><b>(7)</b>
        authenticator = ListenerPasswordAuthenticator { username, paassword -&gt;
            (username === validUser) &amp;&amp; (paassword === validPassword)
        }
    ))

// Start the listener
listener.start() <i class="conum" data-value="8"></i><b>(8)</b>
thisListener = listener</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset12_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">// Initialize the listener
final URLEndpointListener thisListener
  = new URLEndpointListener(thisConfig); <i class="conum" data-value="1"></i><b>(1)</b>

// Start the listener
thisListener.start(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitor-listener"><a class="anchor" href="#monitor-listener"></a>Monitor Listener</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the Listener&#8217;s <code><a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/URLEndpointListener.html#getStatus--">getStatus</a></code> property/method to get counts of total and active connections&#8201;&#8212;&#8201;see: <a href="#get-connection-counts">Example 13</a>.</p>
</div>
<div class="paragraph">
<p>You should note that these counts can be extremely volatile. So, the actual number of active connections may have changed, by the time the <code><a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/com/couchbase/lite/ConnectionStatus.html">ConnectionStatus</a></code> class returns a result.</p>
</div>
<div id="get-connection-counts" class="exampleblock">
<div class="title">Example 13. Get connection counts</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset13_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset13_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset13_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">val connectionCount = listener.status?.connectionCount <i class="conum" data-value="1"></i><b>(1)</b>
val activeConnectionCount = listener.status?.activeConnectionCount <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset13_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">int connectionCount =
  thisListener.getStatus().getConnectionCount(); <i class="conum" data-value="1"></i><b>(1)</b>

int activeConnectionCount =
  thisListener.getStatus().getActiveConnectionCount();  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stop-listener"><a class="anchor" href="#stop-listener"></a>Stop Listener</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is best practice to check tha status of the listener&#8217;s connections and stop only when you have confirmed that there are no active connections&#8201;&#8212;&#8201;see <a href="#get-connection-counts">Example 13</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Stop listener using <code>stop</code> method</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset14_kotlin"></a>Kotlin</p>
</li>
<li>
<p><a id="tabset14_java"></a>Java</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset14_kotlin">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Kotlin hljs" data-lang="Kotlin" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.kt">thisListener?.stop()</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset14_java">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/android/examples/codesnippet_collection.java">thisListener.stop();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Closing the database will also close the listener.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content"><a class="anchor" href="#related-content"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id=""><a class="anchor" href="#"></a></h6>
<div class="ulist">
<div class="title">How to</div>
<ul>
<li>
<p><a href="p2psync-websocket-using-passive.html" class="xref page">Passive Peer</a></p>
</li>
<li>
<p><a href="p2psync-websocket-using-active.html" class="xref page">Active Peer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-2"><a class="anchor" href="#-2"></a></h6>
<div class="ulist">
<div class="title">Concepts</div>
<ul>
<li>
<p><a href="#android:landing-p2psync.adoc" class="xref unresolved">Peer-to-Peer Sync</a></p>
</li>
<li>
<p><a href="http://docs.couchbase.com/mobile/3.0.2/couchbase-lite-android/">API References</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-3"><a class="anchor" href="#-3"></a></h6>
<div class="paragraph">
<div class="title">Community Resources &#8230;&#8203;</div>
<p><a href="https://forums.couchbase.com/c/mobile/14">Mobile Forum</a> |
<a href="https://blog.couchbase.com/">Blog</a> |
<a href="https://docs.couchbase.com/tutorials/">Tutorials</a></p>
</div>
<div class="paragraph">
<div class="title"></div>
<p><a href="#tutorials:cbl-p2p-sync-websockets:swift/cbl-p2p-sync-websockets.adoc" class="xref unresolved">Getting Started with Peer-to-Peer Synchronization</a></p>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
