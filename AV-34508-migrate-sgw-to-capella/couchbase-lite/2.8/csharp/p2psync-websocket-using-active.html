<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Active Peer | Couchbase Capella Staging Docs</title>
<link rel="canonical" href="https://docs.stage.nonprod-project-avengers.com/couchbase-lite/2.8/csharp/p2psync-websocket-using-active.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Lite&#x27;s Peer-to-Peer Synchronization enables edge devices to synchronize securely without consuming centralized cloud-server resources">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="2.8">
<meta name="page-url" content="/couchbase-lite/2.8/csharp/p2psync-websocket-using-active.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.stage.nonprod-project-avengers.com/cloud/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.stage.nonprod-project-avengers.com/cloud/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/hakimcassimally/couchbase/docs-couchbase-lite/modules/csharp/pages/p2psync-websocket-using-active.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../index.html">Couchbase Lite</a></li>
<li class="crumb"><a href="p2psync-websocket-using-active.html">Active Peer</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Active Peer</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Enterprise</a></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/_partials/_std-cbl-hdr.adoc - include::shared-mobile::partial$_attributes-shared.adoc[]</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/_partials/_glossary-links.adoc - include::shared-mobile::partial$_attributes-shared.adoc[]</p>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Description&#8201;&#8212;&#8201;<em>Couchbase Lite&#8217;s Peer-to-Peer Synchronization enables edge devices to synchronize securely without consuming centralized cloud-server resources</em><br>
<em>Abstract&#8201;&#8212;&#8201;How to set up a Replicator to connect with a Listener and replicate changes using peer-to-peer sync</em><br>
Related Content&#8201;&#8212;&#8201;<a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net">API Reference</a>  |  <a href="p2psync-websocket-using-passive.html" class="xref page">Passive Peer</a>  |  <a href="p2psync-websocket-using-active.html" class="xref page">Active Peer</a></p>
</div>
</blockquote>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Enterprise Edition only</div>
This an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.
Purchase the <em>Enterprise License</em>, which includes official <a href="https://www.couchbase.com/support-policy">Couchbase Support</a>, to use it in production (see the license and support <a href="https://www.couchbase.com/licensing-and-support-faq" class="bare">https://www.couchbase.com/licensing-and-support-faq</a>).
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Code Snippets</div>
The code examples are indicative only.
They demonstrate basic concepts and approaches to using a feature.
Use them as inspiration and adapt these examples to best practice when developing applications for your platform.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This content provides sample code and configuration examples covering the implementation of <a href="refer-glossary.html#peer-to-peer-sync" class="xref page">Peer-to-Peer Sync</a> over websockets.
Specifically it covers the implementation of an <a href="refer-glossary.html#active-peer" class="xref page">Active Peer</a>.</p>
</div>
<div class="paragraph">
<p>This <em>active peer</em> (also referred to as a client and-or a replicator) will initiate connection with a <a href="refer-glossary.html#passive-peer" class="xref page">Passive Peer</a> (also referred to as a server and-or listener) and participate in the replication of database changes to bring both databases into sync.</p>
</div>
<div class="paragraph">
<p>Subsequent sections provide additional details and examples for the main configuration options.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Secure Storage</div>
The use of TLS, its associated keys and certificates requires using secure storage to minimize the chances of a security breach.
The implementation of this storage differs from platform to platform&#8201;&#8212;&#8201;see <a href="p2psync-websocket.html#using-secure-storage" class="xref page">Using secure storage</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-summary"><a class="anchor" href="#configuration-summary"></a>Configuration Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You should configure and initialize a replicator for each Couchbase Lite database instance you want to sync.
<a href="#simple-replication-to-listener">Example 1</a> shows the initialization and configuration process.</p>
</div>
<div id="simple-replication-to-listener" class="exampleblock">
<div class="title">Example 1. Replication configuration and initialization</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// . . . preceding code. for example . . .
private static ListenerToken _thisListenerToken;
var Database thisDB;
// . . . other code . . .
// initialize the replicator configuration

var thisUrl = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="1"></i><b>(1)</b>
var config = new ReplicatorConfiguration(thisDB, thisUrl);


// Set replicator type
thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

// Configure Sync Mode
thisConfig.Continuous = true; // default value

// Configure Server Security -- only accept self-signed certs
thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="2"></i><b>(2)</b>

// Configure Client Security <i class="conum" data-value="3"></i><b>(3)</b>
// Configure basic auth using user credentials
thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

/* Optionally set a conflict resolver call back */ <i class="conum" data-value="4"></i><b>(4)</b>
// Use built-in resolver
thisConfig.ConflictResolver = new LocalWinConflictResolver();  //

// optionally use custom resolver
thisConfig.ConflictResolver = new ConflictResolver(
  (conflict) =&gt; {
    /* define resolver function */
  }
); //

// Initialize and start a replicator
// Initialize replicator with configuration data
var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="5"></i><b>(5)</b>

//Optionally add a change listener <i class="conum" data-value="6"></i><b>(6)</b>
_thisListenerToken =
  thisReplicator.AddChangeListener((sender, args) =&gt;
    {
      if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
          Console.WriteLine("Replication stopped");
      }
    });

// Start replicator
thisReplicator.Start(); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a> class&#8217;s constructor&#8201;&#8212;&#8201;<a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration__ctor_Couchbase_Lite_Database_Couchbase_Lite_Sync_IEndpoint">ReplicatorConfiguration(Database database, IEndpoint target)</a>&#8201;&#8212;&#8201;to initialize the replicator configuration with the local database&#8201;&#8212;&#8201;see also: <a href="#configure-target">[configure-target]</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure how the client will authenticate the server.
Here we say connect only to servers presenting a self-signed certificate.
By default, clients accept only servers presenting certificates that can be verified using the OS bundled Root CA Certificates&#8201;&#8212;&#8201;see: <a href="#authenticating-the-listener">[authenticating-the-listener]</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the credentials the client will present to the server.
Here we say to provide <em>Basic Authentication</em> credentials. Other options are available&#8201;&#8212;&#8201;see: <a href="#client-authentication">[client-authentication]</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure how the replication should perform <a href="#conflict-resolution">Conflict Resolution</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialize the replicator using your configuration object.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register an observer, which will notify you of changes to the replication status.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Start the replicator.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-references"><a class="anchor" href="#api-references"></a>API References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net">C#.Net API References</a> here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="device-discovery"><a class="anchor" href="#device-discovery"></a>Device Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>This phase is optional:</strong> If the listener is initialized on a well known URL endpoint (for example, a static IP Address or well known DNS address) then you can configure active peers to connect to those.</p>
</div>
<div class="paragraph">
<p>Prior to connecting with a listener you may execute a peer discovery phase to dynamically discover peers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-replicator"><a class="anchor" href="#configure-replicator"></a>Configure Replicator</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">In this section</dt>
<dd>
<p><a href="#lbl-cfg-tgt">Configure Target</a>  |  <a href="#lbl-cfg-sync">Sync Mode</a>  |  <a href="#lbl-cfg-htbt">Heartbeat</a>  |  <a href="#lbl-auth-lstnr">Authenticating the Listener</a>  | <a href="#lbl-authclnt">Client Authentication</a></p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="lbl-cfg-tgt"><a class="anchor" href="#lbl-cfg-tgt"></a>Configure Target</h3>
<div class="paragraph">
<p>Use the
<a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a> class and <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration__ctor_Couchbase_Lite_Database_Couchbase_Lite_Sync_IEndpoint">ReplicatorConfiguration(Database database, IEndpoint target)</a> constructor to initialize the replication configuration with local and remote database locations.</p>
</div>
<div class="paragraph">
<p>The constructor provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the name of the local database to be sync&#8217;d</p>
</li>
<li>
<p>the server&#8217;s URL (including the port number and the name of the remote database to sync with)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>It is expected that the app will identify the IP address and URL and append the remote database name to the URL endpoint, producing for example: <code>wss://10.0.2.2:4984/travel-sample</code></p>
</div>
<div class="paragraph">
<p>The URL scheme for web socket URLs uses <code>ws:</code> (non-TLS) or <code>wss:</code> (SSL/TLS) prefixes.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 2. Add Target to Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/p2psync-websocket.cs">// initialize the replicator configuration

var thisUrl = new URLEndpoint("wss://l10.0.2.2:4984/anotherDB"); <i class="conum" data-value="1"></i><b>(1)</b>
var config = new ReplicatorConfiguration(thisDB, thisUrl);</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note use of the <code>wss://</code> prefix to ensure TLS encryption (strongly recommended in production)</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lbl-cfg-sync"><a class="anchor" href="#lbl-cfg-sync"></a>Sync Mode</h3>
<div class="paragraph">
<p>Here we define the direction and type of replication we want to initiate.</p>
</div>
<div class="paragraph">
<p>We use <code><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a></code> class&#8217;s <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_ReplicatorType">ReplicatorType</a> and
<code><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_Continuous">Continuous</a></code> parameters, to tell the replicator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The direction of the replication:
<code><strong>pushAndPull</strong></code>; <code>pull</code>; <code>push</code></p>
</li>
<li>
<p>The type of replication, that is:</p>
<div class="ulist">
<ul>
<li>
<p>Continuous&#8201;&#8212;&#8201;remaining active indefinitely to replicate changed documents (<code>continuous=true</code>).</p>
</li>
<li>
<p>Ad-hoc&#8201;&#8212;&#8201;a one-shot replication of changed documents (<code>continuous=false</code>).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="ex-repl-sync" class="exampleblock">
<div class="title">Example 3. Configure replicator type and mode</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Set replicator type
thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

// Configure Sync Mode
thisConfig.Continuous = true; // default value</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lbl-cfg-htbt"><a class="anchor" href="#lbl-cfg-htbt"></a>Heartbeat</h3>
<div class="paragraph">
<p>A point to consider when initiating a replication, particularly a continuous replication, is keeping the connection alive.
Couchbase Lite minimizes the chance of dropped connections by having the replicator maintain a heartbeat; essentially pinging the listener at a configurable interval.</p>
</div>
<div class="paragraph">
<p>When necessary you can adjust this interval using  <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_Heartbeat">Heartbeat()</a> as shown in&#8201;&#8212;&#8201;<a href="#ex-htbt">Example 4</a>.</p>
</div>
<div class="paragraph">
<p>The default heartbeat value is 300 (5 minutes).</p>
</div>
<div id="ex-htbt" class="exampleblock">
<div class="title">Example 4. Setting heartbeat interval</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">    var url = new Uri("ws://localhost:4984/mydatabase");
    var target = new URLEndpoint(url);

    var config = new ReplicatorConfiguration(database, target);

//  other config as required . . .

    config.Heartbeat = TimeSpan.FromSeconds(60); //  <i class="conum" data-value="1"></i><b>(1)</b>

//  other config as required . . .

    var repl = new Replicator(config);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>heartbeat</code> value sets the interval (in seconds) between the heartbeat pulses.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lbl-auth-lstnr"><a class="anchor" href="#lbl-auth-lstnr"></a>Authenticating the Listener</h3>
<div class="paragraph">
<p>Define the credentials the your app (the client) is expecting to receive from the server (listener) in order to ensure that the server is one it is prepared to interact with.</p>
</div>
<div class="paragraph">
<p>Note that the client cannot authenticate the server if TLS is turned off.
When TLS is enabled (Sync Gateway&#8217;s default) the client <em>must</em> authenticate the server.
If the server cannot provide acceptable credentials then the connection will fail.</p>
</div>
<div class="paragraph">
<p>Use <code><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a></code> properties <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_AcceptOnlySelfSignedServerCertificate">AcceptOnlySelfSignedServerCertificate</a> and <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_PinnedServerCertificate">PinnedServerCertificate</a>, to tell the replicator how to verify server-supplied TLS server certificates.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is a pinned certificate, nothing else matters, the server cert must <strong>exactly</strong> match the pinned certificate.</p>
</li>
<li>
<p>If there are no pinned certs and <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_AcceptOnlySelfSignedServerCertificate">AcceptOnlySelfSignedServerCertificate</a> is <code>true</code> then any self-signed certificate is accepted.  Certificates that are not self signed are rejected, no matter who signed them.</p>
</li>
<li>
<p>If there are no pinned certificates and <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_AcceptOnlySelfSignedServerCertificate">AcceptOnlySelfSignedServerCertificate</a> is <code>false</code> (default), the client validates the server’s certificates against the system CA certificates.  The server must supply a chain of certificates whose root is signed by one of the certificates in the system CA bundle.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 5. Set Server TLS security</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_ca-cert"></a>CA Cert</p>
</li>
<li>
<p><a id="tabset1_self-signed-cert"></a>Self Signed Cert</p>
</li>
<li>
<p><a id="tabset1_pinned-certificate"></a>Pinned Certificate</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_ca-cert">
<div class="paragraph">
<p>Set the client to expect and accept only CA attested certificates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Configure Server Security -- only accept CA certs
thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the default.
Only certificate chains with roots signed by a trusted CA are allowed.
Self signed certificates are not allowed.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_self-signed-cert">
<div class="paragraph">
<p>Set the client to expect and accept only self-signed certificates</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Configure Server Security -- only accept self-signed certs
thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set this to <code>true</code> to accept any self signed cert.
Any certificates that are not self-signed are rejected.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_pinned-certificate">
<div class="paragraph">
<p>Set the client to expect and accept only a pinned certificate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Only CA Certs accepted
thisConfig.AcceptOnlySelfSignedServerCertificate =
  false; <i class="conum" data-value="1"></i><b>(1)</b>

var thisCert =
  new X509Certificate2(caData); <i class="conum" data-value="2"></i><b>(2)</b>

thisConfig.PinnedServerCertificate =
  thisCert; <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure to accept only CA certs</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the pinned certificate using data from the byte array <code>cert</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the certificate to be compared with that provided by the server</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lbl-authclnt"><a class="anchor" href="#lbl-authclnt"></a>Client Authentication</h3>
<div class="paragraph">
<p>Here we define the credentials that the client can present to the server if prompted to do so in order that the server can authenticate it.</p>
</div>
<div class="paragraph">
<p>We use <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a>'s <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_Authenticator">Authenticator</a> method to define the authentication method to the replicator - see <a href="#configuring-client-authentication">Example 7</a>.</p>
</div>
<div class="sect3">
<h4 id="basic-authentication"><a class="anchor" href="#basic-authentication"></a>Basic Authentication</h4>
<div class="paragraph">
<p>Use the <code><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.BasicAuthenticator.html">BasicAuthenticator</a></code> to supply basic authentication credentials (username and password).</p>
</div>
<div id="basic-authentication" class="exampleblock">
<div class="title">Example 6. Basic Authentication</div>
<div class="content">
<div class="paragraph">
<p>This example shows basic authentication using user name and password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Configure basic auth using user credentials
thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

// Configure basic auth using user credentials
thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="certificate-authentication"><a class="anchor" href="#certificate-authentication"></a>Certificate Authentication</h4>
<div class="paragraph">
<p>Use the <code><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.P2P.ClientCertificateAuthenticator.html">ClientCertificateAuthenticator</a></code> to configure the client TLS certificates to be presented to the server, on connection.
This applies only to the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.P2P.URLEndpointListener.html">URLEndpointListener</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <strong>server</strong> (listener) must have <code>disableTLS</code> set <code>false</code> and have a <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.P2P.ClientCertificateAuthenticator.html">ClientCertificateAuthenticator</a> configured, or it will never ask for this client&#8217;s certificate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The certificate to be presented to the server will need to be signed by the root certificates or be valid based on the authentication callback set to the listener via ListenerCertificateAuthenticator.</p>
</div>
<div id="configuring-client-authentication" class="exampleblock">
<div class="title">Example 7. Client Cert Authentication</div>
<div class="content">
<div class="paragraph">
<p>This example shows client certificate authentication using an identity from secure storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Client identity
thisIdentity =
  TLSIdentity.ImportIdentity(_store,
    clientData,
    "123",
    "CBL-Client-Cert",
    null); <i class="conum" data-value="1"></i><b>(1)</b>

thisConfig.Authenticator =
  new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get an identity from secure storage and create a TLS Identity object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the authenticator to <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.P2P.ClientCertificateAuthenticator.html">ClientCertificateAuthenticator</a> and configure it to use the retrieved identity</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initialize-replicator"><a class="anchor" href="#initialize-replicator"></a>Initialize Replicator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html">Replicator</a></code> class&#8217;s <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator__ctor_Couchbase_Lite_Sync_ReplicatorConfiguration_">(ReplicatorConfiguration config)</a> constructor, to initialize the replicator with the configuration you have defined.
You can, optionally, add a change listener (see <a href="#lbl-repl-mon">Monitor Sync</a>) before starting the replicator running using <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Start">Start()</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Initialize and run replicator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Initialize and start a replicator
// Initialize replicator with configuration data
var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="1"></i><b>(1)</b>

// Start replicator
thisReplicator.Start(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize the replicator with the configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the replicator</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-repl-mon"><a class="anchor" href="#lbl-repl-mon"></a>Monitor Sync</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">In this section</dt>
<dd>
<p><a href="#lbl-repl-chng">Change Listeners</a>  |  <a href="#lbl-repl-status">Replicator Status</a>  |  <a href="#lbl-repl-pend">Documents Pending Push</a></p>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In this section</dt>
<dd>
<p><a href="#lbl-repl-chng">Change Listeners</a>  |  <a href="#lbl-repl-status">Replicator Status</a>  |  <a href="#lbl-repl-evnts">[lbl-repl-evnts]</a> | <a href="#lbl-repl-pend">Documents Pending Push</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can monitor a replication’s status by using a combination of <a href="#lbl-repl-chng">Change Listeners</a> and the <code>replication.status.activity</code> property&#8201;&#8212;&#8201;see; <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Activity">Activity</a>.
This enables you to know, for example, when the replication is actively transferring data and when it has stopped.</p>
</div>
<div class="paragraph">
<p>You can also choose to monitor document changes&#8201;&#8212;&#8201;see: <a href="#lbl-repl-evnts">[lbl-repl-evnts]</a>.</p>
</div>
<div class="sect2">
<h3 id="lbl-repl-chng"><a class="anchor" href="#lbl-repl-chng"></a>Change Listeners</h3>
<div class="paragraph">
<p>Use this to monitor changes and to inform on sync progress; this is an optional step.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Best Practice</div>
You should register the listener before starting your replication, to avoid having to do a restart to activate it &#8230;&#8203; and don&#8217;t forget to save the token so you can remove the listener later
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html">Replicator</a> class to add a change listener as a callback to the Replicator (<a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_AddChangeListener_System_EventHandler_Couchbase_Lite_Sync_ReplicatorStatusChangedEventArgs__">addChangeListener()</a>)&#8201;&#8212;&#8201;see: <a href="#ex-repl-mon">Example 9</a>.
You will then be asynchronously notified of state changes.</p>
</div>
<div class="paragraph">
<p>Remove your change listener before stopping the replicator&#8201;&#8212;&#8201;use the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_RemoveChangeListener_Couchbase_Lite_ListenerToken_">RemoveChangeListener(ListenerToken)</a> method to do this.</p>
</div>
</div>
<div class="sect2">
<h3 id="lbl-repl-status"><a class="anchor" href="#lbl-repl-status"></a>Replicator Status</h3>
<div class="paragraph">
<p>You can use the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html">Replicator</a> class&#8217;s <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Status">Replicator.Status</a> property to check the replicator status.
That is, whether it is actively transferring data or if it has stopped&#8201;&#8212;&#8201;see: <a href="#ex-repl-mon">Example 9</a>.</p>
</div>
<div class="paragraph">
<p>The returned <em>ReplicationStatus</em> structure comprises:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Activity">Activity</a>&#8201;&#8212;&#8201;stopped, offline, connecting, idle or busy&#8201;&#8212;&#8201;see states described in: <a href="#tbl-states">Table 1</a></p>
</li>
<li>
<p><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Progress">Progress</a></p>
<div class="ulist">
<ul>
<li>
<p>completed&#8201;&#8212;&#8201;the total number of changes completed</p>
</li>
<li>
<p>total&#8201;&#8212;&#8201;the total number of changes to be processed</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Error">Error</a>&#8201;&#8212;&#8201;the current error, if any</p>
</li>
</ul>
</div>
<div id="ex-repl-mon" class="exampleblock">
<div class="title">Example 9. Monitor replication</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_adding-a-change-listener"></a>Adding a Change Listener</p>
</li>
<li>
<p><a id="tabset2_using-replicator-status"></a>Using replicator.status</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_adding-a-change-listener">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">_thisListenerToken =
  thisReplicator.AddChangeListener((sender, args) =&gt;
    {
      if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
          Console.WriteLine("Replication stopped");
      }
    });</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_using-replicator-status">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">_thisReplicator.Stop();
while (_thisReplicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
    // Database cannot close until replicators are stopped
    Console.WriteLine($"Waiting for replicator to stop (currently {_thisReplicator.Status.Activity})...");
    Thread.Sleep(200);
}
_thisDatabase.Close();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lbl-repl-states"><a class="anchor" href="#lbl-repl-states"></a>Replication States</h4>
<div class="paragraph">
<p><a href="#tbl-states">Table 1</a> shows the different states, or activity levels, reported in the API; and the meaning of each.</p>
</div>
<table id="tbl-states" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Replicator activity levels</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-center valign-top"><p class="tableblock">State</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Meaning</p></th>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>STOPPED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication is finished or hit a fatal error.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>OFFLINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replicator is offline as the remote host is unreachable.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>CONNECTING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replicator is connecting to the remote host.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>IDLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication caught up with all the changes available from the server.
The <code>IDLE</code> state is only used in continuous replications.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>BUSY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication is actively transferring data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The replication change object also has properties to track the progress (<code>change.status.completed</code> and <code>change.status.total</code>).
Since the replication occurs in batches the total count can vary through the course of a replication.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="replication-status-and-app-life-cycle"><a class="anchor" href="#replication-status-and-app-life-cycle"></a>Replication Status and App Life Cycle</h4>
<div class="paragraph">
<p>Couchbase Lite doesn&#8217;t react to OS backgrounding or foregrounding events and replication(s) will continue running as long as the remote system does not terminate the connection and the app does not terminate.
It is generally recommended to stop replications before going into the background otherwise socket connections may be closed by the OS and this may interfere with the replication process.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lbl-repl-pend"><a class="anchor" href="#lbl-repl-pend"></a>Documents Pending Push</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_IsDocumentPending_System_String_">Replicator.IsDocumentPending()</a> is quicker and more efficient.
Use it in preference to returning a list of pending document IDs, where possible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can check whether documents are waiting to be pushed in any forthcoming sync by using either of the following API methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_GetPendingDocumentIDs">Replicator.GetPendingDocumentIDs()</a> method, which returns a list of document IDs that have local changes, but which have not yet been pushed to the server.</p>
<div class="paragraph">
<p>This can be very useful in tracking the progress of a push sync, enabling the app to provide a visual indicator to the end user on its status, or decide when it is safe to exit.</p>
</div>
</li>
<li>
<p>Use the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_IsDocumentPending_System_String_">Replicator.IsDocumentPending()</a> method to quickly check whether an individual document is pending a push.</p>
</li>
</ul>
</div>
<div id="ex-pending" class="exampleblock">
<div class="title">Example 10. Use Pending Document ID API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">var url = new Uri("ws://localhost:4984/mydatabase");
var target = new URLEndpoint(url);
var database = new Database("myDB");
var config = new ReplicatorConfiguration(database, target);
config.ReplicatorType  = ReplicatorType.Push;

var replicator = new Replicator(config);

var mydocids =
  new HashSet &lt;string&gt; (replicator.GetPendingDocumentIDs()); <i class="conum" data-value="1"></i><b>(1)</b>


if (mydocids.Count &gt; 0)
{
    Console.WriteLine($"There are {mydocids.Count} documents pending");
    replicator.AddChangeListener((sender, change) =&gt;
    {
        Console.WriteLine($"Replicator activity level is " +
                          change.Status.Activity.ToString());
        // iterate and report-on previously
        // retrieved pending docids 'list'
        foreach (var thisId in mydocids)
            if (!replicator.IsDocumentPending(thisId)) <i class="conum" data-value="2"></i><b>(2)</b>
            {
                Console.WriteLine($"Doc ID {thisId} now pushed");
            };
    });

    replicator.Start();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_GetPendingDocumentIDs">Replicator.GetPendingDocumentIDs()</a> returns a list of the document IDs for all documents waiting to be pushed.
This is a snapshot and may have changed by the time the response is received and processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_IsDocumentPending_System_String_">Replicator.IsDocumentPending()</a> returns <code>true</code> if the document is waiting to be pushed, and <code>false</code> otherwise.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lbl-repl-stop"><a class="anchor" href="#lbl-repl-stop"></a>Stop Sync</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stopping a replication is straightforward.
It is done using <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Stop">Stop()</a>.
This initiates an asynchronous operation and so is not necessarily immediate.
Your app should account for this potential delay before attempting any subsequent operations, for example closing the database.</p>
</div>
<div class="paragraph">
<p>You can find further information on database operations in <a href="database.html" class="xref page">Databases</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Best Practice</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When you start a change listener, save the returned token, you will need it when you remove the listener</p>
</li>
<li>
<p>You can ensure the replication has completely stopped by checking for a replication status = STOPPED</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 11. Stop replicator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">// Stop replication.
thisReplicator.Stop(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we initiate the stopping of the replication using the <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Stop">Stop()</a> method.
We can then remove any active <a href="#lbl-repl-chng">change listener</a>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conflict-resolution"><a class="anchor" href="#conflict-resolution"></a>Conflict Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unless you specify otherwise, Couchbase Lite&#8217;s default conflict resolution policy is applied&#8201;&#8212;&#8201;see <a href="#couchbase-lite:csharp:{cbl-pg-conflict-auto}">Automatic Conflict Resolution</a>.</p>
</div>
<div class="paragraph">
<p>To use a different policy, specify a <em>conflict resolver</em> using <a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_ConflictResolver">ConflictResolver</a> as shown in <a href="#using-conflict-resolvers">Example 12</a>.</p>
</div>
<div class="paragraph">
<p>For more complex solutions you can provide a custom conflict resolver - see: <a href="#couchbase-lite:csharp:{cbl-pg-conflict-custom}">Custom Conflict Resolution</a>.</p>
</div>
<div id="using-conflict-resolvers" class="exampleblock">
<div class="title">Example 12. Using conflict resolvers</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_local-wins"></a>Local Wins</p>
</li>
<li>
<p><a id="tabset3_remote-wins"></a>Remote Wins</p>
</li>
<li>
<p><a id="tabset3_merge"></a>Merge</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_local-wins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">class LocalWinConflictResolver : IConflictResolver
{
    Document Resolve(Conflict conflict)
    {
        return conflict.LocalDocument;
    }
}</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_remote-wins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">class RemoteWinConflictResolver : IConflictResolver
{
    public Document Resolve(Conflict conflict)
    {
        return conflict.RemoteDocument;
    }
}</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_merge">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">class MergeConflictResolver : IConflictResolver
{
    public Document Resolve(Conflict conflict)
    {
        var localDict = conflict.LocalDocument.ToDictionary();
        var remoteDict = conflict.RemoteDocument.ToDictionary();
        var result = localDict.Concat(remoteDict)
           .GroupBy(kv =&gt; kv.Key)
           .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
        return new MutableDocument(conflict.DocumentID, result);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Just as a replicator may observe a conflict&#8201;&#8212;&#8201;when updating a document that has changed both in the local database and in a remote database&#8201;&#8212;&#8201;any attempt to save a document may also observe a conflict, if a replication has taken place since the local app retrieved the document from the database. To address that possibility, a version of the <code>Database.save()</code> method also takes a conflict resolver as shown in <a href="#merging-document-properties">[merging-document-properties]</a>.</p>
</div>
<div id="merging-document-properties" class="paragraph">
<p>The following code snippet shows an example of merging properties from the existing document (<code>current</code>) into the one being saved (<code>new</code>).
In the event of conflicting keys, it will pick the key value from <code>new</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Merging document properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/osfameron/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs#L124-L137">using (var document = database.GetDocument("xyz"))
using (var mutableDocument = document.ToMutable()) {
    mutableDocument.SetString("name", "apples");
    database.Save(mutableDocument, (updated, current) =&gt;
    {
        var currentDict = current.ToDictionary();
        var newDict = updated.ToDictionary();
        var result = newDict.Concat(currentDict)
            .GroupBy(kv =&gt; kv.Key)
            .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
        updated.SetData(result);
        return true;
    });
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content"><a class="anchor" href="#related-content"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id=""><a class="anchor" href="#"></a></h6>
<div class="ulist">
<div class="title">How to</div>
<ul>
<li>
<p><a href="p2psync-websocket-using-passive.html" class="xref page">Passive Peer</a></p>
</li>
<li>
<p><a href="p2psync-websocket-using-active.html" class="xref page">Active Peer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-2"><a class="anchor" href="#-2"></a></h6>
<div class="ulist">
<div class="title">Concepts</div>
<ul>
<li>
<p><a href="landing-p2psync.html" class="xref page">Landing P2Psync</a></p>
</li>
<li>
<p><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net">API References</a>
.</p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-3"><a class="anchor" href="#-3"></a></h6>
<div class="paragraph">
<div class="title">Community Resources &#8230;&#8203;</div>
<p>Unresolved include directive in modules/ROOT/pages/_partials/_related-content.adoc - include::shared-mobile::partial$_related-content.adoc[]</p>
</div>
<div class="ulist">
<div class="title"></div>
<ul>
<li>
<p><a href="#tutorials:cbl-p2p-sync-websockets:swift/cbl-p2p-sync-websockets.adoc" class="xref unresolved">Getting Started with Peer-to-Peer Synchronization</a></p>
</li>
</ul>
</div>
</div>
<div class="paragraph">
<p>For more on replicator conflict resolution see: <a href="conflict.html" class="xref page">Handling Data Conflicts</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="delta-sync"><a class="anchor" href="#delta-sync"></a>Delta Sync</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If delta sync is enabled on the listener, then replication will use delta sync.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content-2"><a class="anchor" href="#related-content-2"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id="-4"><a class="anchor" href="#-4"></a></h6>
<div class="ulist">
<div class="title">How to</div>
<ul>
<li>
<p><a href="p2psync-websocket-using-passive.html" class="xref page">Passive Peer</a></p>
</li>
<li>
<p><a href="p2psync-websocket-using-active.html" class="xref page">Active Peer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-5"><a class="anchor" href="#-5"></a></h6>
<div class="ulist">
<div class="title">Concepts</div>
<ul>
<li>
<p><a href="landing-p2psync.html" class="xref page">Landing P2Psync</a></p>
</li>
<li>
<p><a href="http://docs.couchbase.com/mobile/{major}.{minor}.4/couchbase-lite-net">API References</a>
.</p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-6"><a class="anchor" href="#-6"></a></h6>
<div class="paragraph">
<div class="title">Community Resources &#8230;&#8203;</div>
<p>Unresolved include directive in modules/ROOT/pages/_partials/_related-content.adoc - include::shared-mobile::partial$_related-content.adoc[]</p>
</div>
<div class="ulist">
<div class="title"></div>
<ul>
<li>
<p><a href="#tutorials:cbl-p2p-sync-websockets:swift/cbl-p2p-sync-websockets.adoc" class="xref unresolved">Getting Started with Peer-to-Peer Synchronization</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Mobile","components":["couchbase-lite"],"url":"/home/mobile.html","latestVersions":{"couchbase-lite":"2.8"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
